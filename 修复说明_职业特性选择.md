# 🔧 职业特性选择问题修复

## ✅ 问题已修复

**问题**：选择牧师后，没有看到职业特性选择（圣约 Divine Order）

**根本原因**：
- v2.0 重构后，`StepClassSimple` 只选择职业，不包含特性选择
- `ClassFeatureSelector` 组件存在但没有被使用
- 牧师、战士、术士、邪术师等职业的特性选择功能缺失

---

## 🛠️ 修复内容

### 1. 修改 `StepSkills.tsx`

**添加职业特性选择功能**

#### 新增功能：

1. **检测职业特性选择需求**
   - 从职业数据中获取 `featureChoices`
   - 检查是否有未选择的特性
   - 优先于技能选择显示

2. **显示职业特性选择器**
   - 使用 `ClassFeatureSelector` 组件
   - 一次显示一个特性选择
   - 显示已选择的特性列表

3. **保存特性选择**
   - 存储到 `classFeatureChoices` 对象
   - 格式：`{ "divineOrder": "protector", ... }`

4. **流程控制**
   - 先选择职业特性（如果有）
   - 再选择职业技能
   - 最后显示技能总览

---

### 2. 修复 `ClassFeatureSelector.tsx`

**修复 useEffect 依赖问题**
- 移除 `onComplete` 依赖
- 避免无限循环

---

## 🎯 新的步骤 5 流程

### 完整流程

```
步骤 5：选择技能和特性

1. 职业特性选择（如果职业有特性）
   → 显示特性选择器
   → 用户选择一个选项
   → 自动保存 ✓
   → 如果有多个特性，继续选择下一个
   → 所有特性选择完成

2. 职业技能选择
   → 自动添加背景技能
   → 显示职业技能选择器
   → 用户选择技能
   → 选择完成 ✓

3. 技能总览
   → 显示所有技能
   → 区分职业/背景技能
   → 完成步骤
```

---

## 📊 有职业特性的职业

### 牧师 (Cleric)

**特性**：圣职选择 (Divine Order)  
**选项**：
- **守护者 (Protector)**
  - 获得军用武器熟练
  - 获得重甲熟练
  - 适合近战战斗的牧师

- **奇术师 (Thaumaturge)**
  - 额外学习1个牧师戏法
  - 奥秘和宗教检定加上感知调整值
  - 适合施法为主的牧师

---

### 战士 (Fighter)

**特性**：战斗风格 (Fighting Style)  
**选项**：
- **防御 (Defense)** - 穿甲时 AC +1
- **决斗 (Dueling)** - 单手武器伤害 +2
- **强攻 (Great Weapon Fighting)** - 双手武器重骰1和2
- **保护 (Protection)** - 给5尺内盟友攻击劣势
- **射击 (Archery)** - 远程攻击 +2

---

### 术士 (Sorcerer)

**特性**：术士起源 (Sorcerous Origin)  
**选项**：
- **龙裔血脉 (Draconic Bloodline)**
- **狂野魔法 (Wild Magic)**
- 等等

---

### 邪术师 (Warlock)

**特性**：契约恩赐 (Pact Boon)  
**选项**：
- **魔刃契约 (Pact of the Blade)**
- **魔典契约 (Pact of the Tome)**
- **魔灵契约 (Pact of the Chain)**

---

## 🧪 测试流程

### ⚠️ 第一步：强制刷新

**Mac**：`Cmd + Shift + R`  
**Windows**：`Ctrl + Shift + R`

---

### 完整测试（5分钟）

```
1. 访问 http://localhost:3000

2. 创建新角色

3. 快速完成前 4 步：
   
   步骤 0：欢迎
   → 下一步
   
   步骤 1：职业
   → 选择"牧师" ⭐
   → 下一步
   
   步骤 2：起源
   → 2.1 背景：选择"侍僧"，装备选"选项A"
   → 2.2 物种：选择"人类"，完成特性和专长
   → 2.3 语言：选择2种语言
   → 下一步
   
   步骤 3：属性
   → 快速分配
   → 下一步
   
   步骤 4：阵营
   → 选择一个阵营
   → 下一步

4. 🎯 步骤 5：选择技能和特性（重点测试）
   
   【第一页：职业特性选择】⭐
   
   应该看到：
   
   ✅ 标题："选择职业特性"
   ✅ 说明："定制您的 牧师 职业能力"
   ✅ 特性名称："圣职选择 (Divine Order)"
   
   ✅ 两个选项卡片：
   
   选项 1：守护者 (Protector)
   → 描述："你训练成为战场上的神圣卫士"
   → 能力：
     • 获得军用武器熟练
     • 获得重甲熟练
     • 适合近战战斗的牧师
   
   选项 2：奇术师 (Thaumaturge)
   → 描述："你专注于神圣魔法和知识"
   → 能力：
     • 额外学习1个牧师戏法
     • 奥秘和宗教检定加上感知调整值
     • 适合施法为主的牧师
   
   → 点击"守护者" ✓
   → 看到"✓ 特性选择完成！"
   → 页面自动刷新
   
   【第二页：职业技能选择】
   
   ✅ 看到背景技能（绿色框）
   ✅ 看到职业技能选择器
   → 选择2个技能
   → 完成 ✓

5. 步骤 7：审核完成
   
   检查：
   ✅ 职业特性选择
   → 看到"圣职选择 (Divine Order)：守护者 (Protector)"
   
   ✅ 技能正确
   ✅ 所有信息完整

6. 导出 PDF
   → 查看 PDF 包含职业特性信息
```

---

## ✅ 预期效果

### 步骤 5 - 职业特性选择（新增）⭐

#### 显示时机：
- ✅ 选择了有特性的职业（牧师/战士/术士/邪术师）
- ✅ 还没有选择该特性

#### 界面内容：
- ✅ 标题和说明
- ✅ 特性名称（如"圣职选择"）
- ✅ 选项卡片（2-5个）
- ✅ 每个选项有名称、描述、能力列表

#### 交互：
- ✅ 点击选项立即选中（紫色边框）
- ✅ 看到完成提示
- ✅ 自动进入下一个特性或技能选择
- ✅ 可以返回修改

---

### 步骤 5 - 技能选择（原有）

#### 显示时机：
- ✅ 所有职业特性已选择（如果有）
- ✅ 还没有选择足够的职业技能

#### 内容：
- ✅ 背景技能（自动）
- ✅ 职业技能选择器
- ✅ 选择完成提示

---

### 审核页面

#### 新增显示：
- ✅ 职业特性选择部分
- ✅ 显示特性名称和选择的选项
- ✅ 来源标注（职业名称）

---

## 📝 技术细节

### 职业特性数据结构

```typescript
// lib/dnd-data.ts - CLASSES 数组

{
  id: 'cleric',
  name: '牧师',
  // ... 其他数据
  featureChoices: [
    {
      id: 'divineOrder',
      name: '圣职选择 (Divine Order)',
      level: 1,
      options: [
        {
          id: 'protector',
          name: '守护者 (Protector)',
          description: '你训练成为战场上的神圣卫士',
          benefits: [
            '获得军用武器熟练',
            '获得重甲熟练',
            '适合近战战斗的牧师'
          ]
        },
        {
          id: 'thaumaturge',
          name: '奇术师 (Thaumaturge)',
          description: '你专注于神圣魔法和知识',
          benefits: [
            '额外学习1个牧师戏法',
            '奥秘和宗教检定加上感知调整值',
            '适合施法为主的牧师'
          ]
        }
      ]
    }
  ]
}
```

---

### 存储特性选择

```typescript
// Character 接口

interface Character {
  // ... 其他字段
  classFeatureChoices?: Record<string, string>;
  // 格式：{ "divineOrder": "protector", "fightingStyle": "dueling" }
}
```

---

### 检测未选择的特性

```typescript
// StepSkills.tsx (第 48-56 行)

// 获取职业特性选择
const classFeatureChoices = (classData as any)?.featureChoices || [];
const currentChoices = currentCharacter.classFeatureChoices || {};

// 检查是否需要选择职业特性
const needsClassFeatures = classFeatureChoices.length > 0 && 
  classFeatureChoices.some((feature: any) => !currentChoices[feature.id]);

// 获取第一个未选择的职业特性
const nextFeatureToChoose = classFeatureChoices.find(
  (feature: any) => !currentChoices[feature.id]
);
```

---

### 保存特性选择

```typescript
// StepSkills.tsx (第 61-68 行)

// 处理职业特性选择完成
const handleFeatureComplete = (featureId: string, selectedOptionId: string) => {
  const updatedChoices = {
    ...currentChoices,
    [featureId]: selectedOptionId
  };
  updateCurrentCharacter({
    classFeatureChoices: updatedChoices
  });
};
```

---

## 🎓 各职业特性选择

| 职业 | 特性名称 | 选项数量 | 影响 |
|------|---------|---------|------|
| 牧师 | 圣职选择 | 2 | 战斗风格 |
| 战士 | 战斗风格 | 5 | 战斗策略 |
| 术士 | 术士起源 | 2+ | 魔法来源 |
| 邪术师 | 契约恩赐 | 3 | 能力类型 |
| 野蛮人 | 无 | - | - |
| 吟游诗人 | 无 | - | - |
| 德鲁伊 | 无 | - | - |
| 武僧 | 无 | - | - |
| 圣武士 | 无 | - | - |
| 游侠 | 无 | - | - |
| 游荡者 | 无 | - | - |
| 法师 | 无 | - | - |

**注意**：当前只有牧师、战士、术士、邪术师有完整的特性数据。

---

## 📋 验证清单

### 功能测试
- [ ] 选择牧师后，步骤5显示职业特性选择
- [ ] 显示"圣职选择"特性
- [ ] 显示守护者和奇术师两个选项
- [ ] 可以点击选择
- [ ] 选择后显示完成提示
- [ ] 自动进入技能选择
- [ ] 审核页面显示职业特性
- [ ] PDF 包含职业特性信息

### 其他职业测试
- [ ] 战士显示"战斗风格"（5个选项）
- [ ] 术士显示"术士起源"
- [ ] 邪术师显示"契约恩赐"
- [ ] 法师等职业直接进入技能选择

### 技术验证
- [ ] 控制台无错误
- [ ] 无无限循环
- [ ] 页面响应迅速
- [ ] 可以返回修改选择

---

## 🎊 修复完成！

### 修改的文件
1. `components/steps/StepSkills.tsx` - 添加职业特性选择逻辑
2. `components/ClassFeatureSelector.tsx` - 修复 useEffect 依赖

### 解决的问题
1. ✅ 牧师职业特性选择（圣约）
2. ✅ 战士职业特性选择（战斗风格）
3. ✅ 术士职业特性选择（术士起源）
4. ✅ 邪术师职业特性选择（契约恩赐）

### 现在可以：
- ✅ 选择牧师职业特性（守护者/奇术师）
- ✅ 选择战士战斗风格
- ✅ 选择术士起源
- ✅ 选择邪术师契约恩赐
- ✅ 完整的角色定制流程

---

## 🚀 立即测试

**访问：http://localhost:3000**

**⚠️ 记得强制刷新浏览器！**
- **Mac**：`Cmd + Shift + R`
- **Windows**：`Ctrl + Shift + R`

**选择牧师，体验完整的职业特性选择！** ⚔️🛡️

---

## 💡 提示

### 牧师推荐

**守护者 (Protector)**：
- ✅ 适合前排坦克型牧师
- ✅ 可以穿重甲，使用军用武器
- ✅ 近战战斗 + 治疗辅助

**奇术师 (Thaumaturge)**：
- ✅ 适合后排施法型牧师
- ✅ 更多戏法选择
- ✅ 知识检定加强
- ✅ 纯施法 + 辅助

---

**职业特性选择现在完全可用！** ✨
