# 用户系统开发计划方案

本文档在《用户系统设计方案》基础上，约定**注册、修改密码、更换邮箱**均依赖**阿里云邮箱验证码**，并纳入其他常见用户管理功能，给出分阶段开发计划与建议优先级。

---

## 一、验证码机制约定

| 场景 | 验证码发送目标 | 校验逻辑 |
|------|----------------|----------|
| **注册** | 待注册邮箱 | 用户输入邮箱 → 发送验证码到该邮箱 → 用户提交邮箱+密码+验证码 → 校验通过后创建账号 |
| **修改密码** | 当前账号绑定邮箱 | 用户发起「修改密码」→ 发送验证码到当前邮箱 → 用户提交验证码+新密码 → 校验通过后更新密码 |
| **更换邮箱** | ① 当前邮箱（确认身份）② 新邮箱（确认归属） | 用户发起「更换邮箱」→ 先向**当前邮箱**发验证码，用户输入验证码通过 → 再输入新邮箱，向**新邮箱**发验证码，用户输入新邮箱验证码 → 校验通过后更新邮箱 |
| **忘记密码** | 账号绑定邮箱 | 用户输入邮箱 → 若账号存在则向该邮箱发验证码 → 用户提交邮箱+验证码+新密码 → 校验通过后更新密码（无需旧密码） |

以上均使用**阿里云邮件推送（Direct Mail）**发送验证码；验证码存 `VerificationCode` 表，带 `email`、`type`（如 `register` / `change_password` / `change_email` / `reset_password`）、过期时间与尝试次数限制。

---

## 二、功能清单与归属阶段

下表为「设计方案」中功能 + 你确认的「其他常见功能」的完整清单，并标注建议实现阶段。

| 功能 | 说明 | 阶段 |
|------|------|------|
| 邮箱+密码注册（须邮箱验证码） | 注册时向邮箱发验证码，校验通过后才创建账号 | P1 |
| 邮箱+密码登录 | 登录仅校验邮箱+密码，无需验证码 | P1 |
| 登出 | 清除 session | P1 |
| 登录态约 15 天 | cookie maxAge 15 天；可选「记住我」延长 | P1 |
| 用户以邮箱为主键 | User 表 email 唯一，业务主键 | P1 |
| 注册/登录限流 | 按 IP、邮箱限制验证码与登录尝试频率 | P1 |
| 邮箱验证状态 | 注册即已验证，可存 `emailVerifiedAt`；后续策略可用 | P1 |
| 用户协议与隐私政策勾选 | 注册时勾选，存同意版本与时间 | P1 |
| 个人资料（名称、联系方式） | displayName、contactInfo 等，GET/PUT profile | P2 |
| 查看自己创建的角色卡 | 已有 API，确认按 userId 过滤即可 | P2 |
| 角色卡持久化与权限 | 创建/编辑/删除均用 session.userId，不信任前端 | P2 |
| 角色立绘上传 OSS | 上传得 URL，角色存 URL；兼容旧 base64 | P2 |
| 用户等级（普通/会员） | User.role，会员功能处校验 | P2 |
| 修改密码（须原邮箱验证码） | 向当前邮箱发验证码，验证码+新密码通过后更新 | P2 |
| 忘记密码 | 输入邮箱→发验证码→验证码+新密码重置 | P2 |
| 更换邮箱（须原邮箱+新邮箱验证码） | 当前邮箱验证码 → 新邮箱验证码 → 更新邮箱 | P2 |
| 敏感操作二次验证 | 改密、换邮箱、注销等均用邮箱验证码（已覆盖） | P2 |
| 登录历史 / 安全日志 | 记录登录时间、IP、User-Agent 等，用户可查看 | P3 |
| 多端登出 | 「登出所有设备」：使该用户所有 session 失效 | P3 |
| 账号注销 | 用户申请注销，软删除或标记，策略可配置 | P3 |
| 后台管理员登录 | Admin 表或配置，独立密码，admin session | P4 |
| 后台用户列表/详情 | 分页、筛选、查看用户资料与等级 | P4 |
| 后台重置用户密码 | 管理员可重置任意用户密码（或发重置链接） | P4 |
| 后台修改用户等级 | 普通/会员切换 | P4 |
| 后台查看用户角色卡 | 按用户查看其角色卡列表与详情 | P4 |
| 后台操作审计 | 管理员操作写审计表或日志 | P4 |

---

## 三、分阶段开发计划

### 阶段 P1：基础账号与鉴权（必先完成）

**目标**：用户能通过「邮箱+验证码」注册、「邮箱+密码」登录，会话保持约 15 天，并具备限流与协议勾选。

| 序号 | 任务 | 产出 |
|------|------|------|
| 1.1 | 数据模型：User 增加 email（唯一）、passwordHash、displayName、contactInfo、role、emailVerifiedAt；VerificationCode 增加 email、type | Prisma schema 更新 + migration |
| 1.2 | 验证码表与邮件发送：VerificationCode 支持 type（register/change_password/change_email/reset_password）；接入阿里云 Direct Mail 发验证码 | lib/verification.ts + lib/email.ts（或扩展现有 sms 思路） |
| 1.3 | 注册 API：发送注册验证码、校验验证码后创建用户（写 passwordHash、emailVerifiedAt） | POST /api/auth/send-code（type=register）, POST /api/auth/register |
| 1.4 | 登录 API：邮箱+密码校验，写 session（userId、email），无验证码 | POST /api/auth/login |
| 1.5 | 登出 API：清除 session | POST /api/auth/logout（已有可复用） |
| 1.6 | Session：改为以 email 为主标识，maxAge 15 天；可选「记住我」延长至 30 天 | lib/session.ts 更新 |
| 1.7 | 限流：同一 IP/邮箱 发验证码频率、登录失败次数限制 | 中间件或 API 内逻辑，可存内存/Redis/DB |
| 1.8 | 注册页协议勾选：勾选用户协议与隐私政策，提交时传 agreement 版本；User 表存 agreementAcceptedAt、agreementVersion（可选） | 注册页 UI + 后端校验 |
| 1.9 | 前端注册/登录页：从「手机号+验证码」改为「邮箱+验证码注册」「邮箱+密码登录」 | app/login、app/register（或登录页双 Tab） |

**验收**：能注册（须收邮件验证码）、登录、登出，会话 15 天有效；限流与协议勾选生效。

---

### 阶段 P2：个人资料、安全与角色卡

**目标**：个人资料编辑、修改密码/忘记密码/更换邮箱（均带邮箱验证码）、角色卡权限与立绘 OSS、会员等级。

| 序号 | 任务 | 产出 |
|------|------|------|
| 2.1 | 个人资料 API：GET/PUT 当前用户 displayName、contactInfo 等 | GET/PUT /api/user/profile |
| 2.2 | 个人中心/设置页：展示与编辑资料 | app/settings 或 app/account/profile |
| 2.3 | 修改密码：发验证码到当前邮箱 → 验证码+新密码 → 更新 passwordHash | POST /api/auth/send-code（type=change_password）, PUT /api/user/password |
| 2.4 | 忘记密码：输入邮箱 → 发验证码 → 验证码+新密码重置 | POST /api/auth/send-code（type=reset_password）, POST /api/auth/reset-password |
| 2.5 | 更换邮箱：当前邮箱验证码 → 新邮箱+新邮箱验证码 → 更新 User.email | POST /api/auth/send-code（type=change_email，支持 currentEmail/newEmail）, PUT /api/user/email |
| 2.6 | 安全设置页：修改密码、更换邮箱、忘记密码入口 | app/settings/security |
| 2.7 | 角色卡权限：确认 /api/characters 与 [id] 仅用 session.userId，不信任前端 | 代码审查 + 必要时加固 |
| 2.8 | 立绘上传 OSS：服务端生成上传凭证或服务端代传，返回 URL；角色 data 中 avatar/portraits 存 URL | POST /api/upload/portrait 或 /api/characters/[id]/upload-portrait |
| 2.9 | 前端立绘：创建/编辑角色时上传走 OSS，展示用 URL；兼容已有 base64 | 组件与 character-store 使用新接口 |
| 2.10 | 会员等级：User.role 使用；需「仅会员」的接口与前端按 role 校验 | 预留校验 helper；具体会员功能后续迭代 |

**验收**：能改资料、改密码（邮箱验证码）、忘记密码、换邮箱（双邮箱验证码）；角色卡仅本人可操作；立绘上传为 OSS URL。

---

### 阶段 P3：安全与账号生命周期

**目标**：登录历史、多端登出、账号注销。

| 序号 | 任务 | 产出 |
|------|------|------|
| 3.1 | 登录历史表：LoginLog（userId、ip、userAgent、createdAt）或类似 | Prisma schema + 登录时写入 |
| 3.2 | 查询当前用户登录历史（最近 N 条） | GET /api/user/login-history |
| 3.3 | 安全/账号页展示登录历史 | app/settings/security 或 account |
| 3.4 | 多端登出：方案 A 存服务端 session 表，登出所有设备即删该用户所有 session；方案 B 用户表增加 tokenVersion，session 存版本，登出所有设备即递增版本 | 选型后实现 POST /api/auth/logout-all |
| 3.5 | 账号注销：用户申请注销 → 软删除（deletedAt）或 status=deleted；策略：是否允许恢复、角色卡是否保留/匿名化 | PUT /api/user/deactivate 或 DELETE /api/user（软删） |
| 3.6 | 注销前二次确认：密码或邮箱验证码 | 同上接口入参 |

**验收**：可查看登录历史、可「登出所有设备」、可申请注销并符合策略。

---

### 阶段 P4：后台管理

**目标**：管理员独立登录、用户管理、重置密码、改等级、查看用户角色卡、操作审计。

| 序号 | 任务 | 产出 |
|------|------|------|
| 4.1 | Admin 表或配置：id、username/email、passwordHash；或环境变量首次写入 | Prisma Admin 表 + 种子或脚本 |
| 4.2 | 管理员登录：POST /api/admin/login，校验后写 admin session（与普通 session 隔离） | API + cookie/session 键区分 |
| 4.3 | 后台鉴权中间件：所有 /admin 与 /api/admin/* 校验 admin session | middleware 或 route 内校验 |
| 4.4 | 后台布局与登录页：/admin 重定向到 /admin/login，登录后进 /admin/dashboard | app/admin/* |
| 4.5 | 用户列表：分页、按邮箱/名称/等级筛选 | GET /api/admin/users + 列表页 |
| 4.6 | 用户详情：资料、等级、角色卡数量等 | GET /api/admin/users/[id] + 详情页 |
| 4.7 | 后台重置用户密码：管理员输入新密码或触发「发重置邮件」 | PUT /api/admin/users/[id]/password |
| 4.8 | 后台修改用户等级：普通/会员 | PUT /api/admin/users/[id]/role |
| 4.9 | 查看用户角色卡列表与详情（只读） | GET /api/admin/users/[id]/characters、[id] 详情 |
| 4.10 | 操作审计：AdminAuditLog（adminId、action、targetUserId、payload、createdAt） | 表 + 关键操作写日志 |

**验收**：管理员能登录后台、管理用户、重置密码、改等级、查看用户角色卡，关键操作有审计记录。

---

## 四、依赖与顺序小结

- **P1 是前置**：无账号体系则无后续；先完成注册（邮箱验证码）、登录、session、限流与协议。
- **P2 依赖 P1**：个人资料与安全（改密/换邮箱/忘记密码）依赖已登录或已发邮件能力；角色卡与 OSS 依赖已登录与 User 主键稳定。
- **P3 依赖 P2**：登录历史依赖登录写入；多端登出依赖 session 或 tokenVersion 设计；注销依赖账号与安全设置页。
- **P4 可与其他并行**：仅依赖 Admin 与现有 User/Character 表，可在 P2 后单独排期。

建议实施顺序：**P1 → P2 → P3 → P4**；若资源紧张可先做 **P1 → P2 → P4**，P3（登录历史、多端登出、注销）稍后补。

---

## 五、接口与数据表速查（供实现对照）

- **验证码**：`POST /api/auth/send-code` body: `{ email, type: 'register'|'change_password'|'change_email'|'reset_password', newEmail? }`  
  - 更换邮箱时：先对当前邮箱发 type=change_email（可选带 newEmail），再对新邮箱发一次（newEmail）。
- **注册**：`POST /api/auth/register` body: `{ email, password, code, agreementVersion? }`
- **登录**：`POST /api/auth/login` body: `{ email, password, rememberMe? }`
- **改密**：`PUT /api/user/password` body: `{ code, newPassword }`（须先发 type=change_password）
- **忘记密码**：`POST /api/auth/reset-password` body: `{ email, code, newPassword }`（须先发 type=reset_password）
- **换邮箱**：`PUT /api/user/email` body: `{ currentEmailCode, newEmail, newEmailCode }`（须先向当前邮箱发码、再向 newEmail 发码）

- **VerificationCode**：建议字段 `id, email, code, type, newEmail?, expiresAt, attempts, createdAt`；同一 email+type 可限制未过期仅一条或按业务覆盖。
- **User**：`id, email(unique), passwordHash, displayName?, contactInfo?, role, emailVerifiedAt?, agreementAcceptedAt?, agreementVersion?, createdAt, updatedAt`；若做软删除再加 `deletedAt`。

以上与《用户系统设计方案》一致，本计划仅细化阶段与验收，便于按迭代交付。
