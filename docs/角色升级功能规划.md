# 角色升级功能规划

基于 D&D 5e/2024 等级提升规则与当前代码库现状制定的角色升级功能规划。**规则依据**：项目内 `职业.md`（各职业特性表与子职业）、`兼职 Multiclassing.md`（兼职施法表与先决条件），以及 `lib/spells-data.ts` / `lib/dnd-data.ts` / `lib/class-features-data.ts` 现有结构。

---

## 一、现状概览

### 已有能力

| 模块 | 现状 |
|------|------|
| **等级与角色** | `Character.level`、`Character.class`、`Character.classFeatureChoices` 已存在；创建流程为 1 级角色。 |
| **施法规则** | `getSpellcastingRules(className, level)` 已实现 1～20 级法术位、戏法数、准备法术数（全施法/半施法/魔契师表）。 |
| **法术数据** | 戏法 + **一环**法术已齐全，按 `classes` 归属；**二环及以上法术当前缺失**。 |
| **职业特性** | `CLASS_FEATURES` 仅有各职业 **1 级** 特性；`dnd-data` 中 `featureChoices` 多为 1 级（如圣职、战斗风格、术士起源、契约恩赐），**无 3 级子职业结构**。 |
| **升级页** | `app/characters/[id]/level-up/page.tsx` 为占位页，提示「开发中」，无实际升级流程。 |

### 需补齐的核心点（单职，暂不考虑兼职）

1. **子职业（3 级）**：**所有 12 个职业**均在 3 级选择子职业（见 `职业.md` 各职业「X级：X子职」），需数据与 UI 支持。  
2. **按等级发放的职业特性**：每级可能获得新特性或可选（如战士 2 级「动作如潮」、游荡者 6 级「专精」等）；职业表中还有熟练加值、狂暴次数、诗人骰、术法点、功力、引导神力等数值列，需按等级表驱动。  
3. **法术环位与法术库**：升级后开放更高环位。**已完成**：2～9 环法术已由 `docs/*.md` 经 `scripts/parse-spells-from-docs.mjs` 生成并接入 `ALL_SPELLS`；尚需按职业+环位筛选工具（如 `getSpellsByClass` 扩展出按环位可选列表）。  
4. **升级流程**：生命值、特性选择、子职业选择、新法术/准备数、专长或属性提升（等级因职业而异，见下）等步骤的向导与写回。

---

## 二、数据层设计与扩充

### 2.1 角色模型扩展（Character）

在现有基础上建议增加（或复用）字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| `subclass` | `string?` | 子职业 id，3 级时选择后写入（如 `champion`、`thief`）。 |
| `classFeatureChoices` | 已有 | 继续存放 1 级、3 级等所有「选项类」选择（如 `divineOrder`、`subclass`、`fightingStyle`）。 |

子职业可统一用 `classFeatureChoices.subclass` 存储，或单独 `subclass` 字段，二选一并在全项目统一。（兼职时再考虑按职业存等级与子职业，见第五章。）

### 2.2 职业等级表（Class Level Table）

新增数据结构：**每级**可获得/必须选择的内容。

- **建议文件**：`lib/class-level-table.ts`（或合并进 `dnd-data.ts`）。
- **内容示例**：
  - 每级：获得的固定特性 id 列表、可选特性（如 3 级子职业、2 级战斗风格等）。
  - 与现有 `CLASS_FEATURES` 的 `level1Features` 对齐，并扩展为 `level2Features`、`level3Features`… 或统一为「等级 → 特性列表 + 选项列表」。

示例结构（按职业 + 等级）：

```ts
// 示例：战士
{
  classId: 'fighter',
  levels: {
    1: { features: ['fighting-style', 'second-wind'], choices: [{ id: 'fightingStyle', ... }] },
    2: { features: ['action-surge'] },
    3: { features: [], choices: [{ id: 'subclass', name: '子职业', options: [
      { id: 'champion', name: '勇士', ... },
      { id: 'battle-master', name: '战斗大师', ... },
      { id: 'eldritch-knight', name: '奥法骑士', ... }
    ] }] },
    4: { features: ['ability-score-improvement'], choices: [...] }, // 属性提升或专长
    // ...
  }
}
```

需为 12 个职业各填 1～20 级（可先做 1～5 级，再逐步补全）。

### 2.3 子职业数据（Subclasses）

- **建议**：`lib/subclass-data.ts` 或并入 `dnd-data.ts`。
- 每条：`id`、`name`、`nameEn`、`classId`、`levelGained: 3`、`description`、`features`（3 级、6/7 级等子职业特性）。
- 与「职业等级表」中 3 级选项关联，便于升级向导在 3 级时展示并写入 `classFeatureChoices.subclass` 或 `subclass`。
- **子职业名称来源**（`职业.md`，3 级选择）：
  - 野蛮人：狂战士道途、兽心道途、世界树道途、狂热者道途
  - 吟游诗人：舞蹈学院、魅心学院、逸闻学院、勇气学院
  - 牧师：生命领域、光明领域、诡术领域、战争领域
  - 德鲁伊：大地结社、月亮结社、海洋结社、星辰结社
  - 战士：战斗大师、勇士、奥法骑士、灵能武士
  - 武僧：命流武者、暗影武者、四象武者、散打武者
  - 圣武士：奉献之誓、荣耀之誓、古贤之誓、复仇之誓
  - 游侠：驯兽师、妖精漫游者、幽域追猎者、猎人
  - 游荡者：诡术师、刺客、魂刃、盗贼
  - 术士：畸变术法、时械术法、龙族术法、狂野术法
  - 魔契师：至高妖精宗主、天界宗主、邪魔宗主、旧日支配者宗主
  - 法师：防护师、预言师、塑能师、幻术师

### 2.4 职业特性按等级扩展（class-features-data）

- 当前 `CLASS_FEATURES` 仅有 `level1Features`。
- 扩展为按等级列出特性（或单独「等级→特性」表），例如：
  - 战士 2 级：动作如潮（Action Surge）
  - 游荡者 3 级：子职业 + 可靠才能（Roguish Archetype + Steady Aim 等）
  - 法师 2 级：奥术传承（子职业）等
- 与 2.2 等级表一致，避免重复维护可考虑「等级表」引用「特性 id」，详情仍从 `class-features-data` 查。

### 2.5 法术数据与筛选（spells-data）

- **现状**：戏法 + 1～9 环法术已齐全（0～1 环手写，2～9 环来自 `docs/*.md` 生成并接入 `ALL_SPELLS`）；`getSpellcastingRules` 已支持 1～20 级法术位。
- **待做**：提供按**职业 + 最高环位**筛选可选法术的工具（如 `getSpellsForClassByLevel(className, level)` 或扩展 `getSpellsByClass` 返回各环位列表），供升级向导「选新法术」使用；魔契师 11/13/15/17 级**玄奥秘法**的存储字段（如 `mysticArcanum`）与展示。

---

## 三、升级逻辑（按等级）

### 3.1 通用规则（每级）

- **熟练加值**：已有公式 `2 + Math.floor((level - 1) / 4)`（1 级 +2，5/9/13/17 各 +1）。升级后重算即可。
- **生命值**：  
  - 1 级：职业生命骰最大值 + 体质调整值（已有）。  
  - 2～20 级：可选「掷生命骰」或「固定值」（固定值 = 职业 hitDie/2 + 1 向上取整 + 体质调整值）。  
  - 更新 `hitPoints`（及可选 `currentHitPoints`）。
- **生命骰数量**：等于当前等级，已由等级隐含；若需记录「剩余可用的短休恢复用生命骰」可单独字段。

### 3.2 职业特性与子职业

- **每级**根据「职业等级表」：
  - 若该级有**固定特性**：直接加入角色 `features` 或等效存储。
  - 若该级有**选项**（如 3 级子职业、2 级战斗风格）：
    - 在升级向导中展示选项列表；
    - 用户选择后写入 `classFeatureChoices`（或 `subclass`）。
- **3 级**：若职业有子职业，必须选一个并写入；UI 上可单独一步「选择子职业」。

### 3.3 施法者（据 `职业.md` 各职业施法段落）

- 调用现有 `getSpellcastingRules(className, level)` 得到新等级的戏法数、准备法术数、法术位（1～9 环）等；需与 `职业.md` 中各职业特性表的「戏法」「准备法术」「每环法术位」列一致。
- **升级时**：
  - **戏法**：多数施法职业「每当你获得一个 X 等级时，你都能从你的戏法中选择其一替换为另一道 X 戏法」；吟游诗人/牧师/德鲁伊/术士/魔契师等在 4 级和 10 级**额外习得**一道戏法（见各表「戏法」列）。
  - **准备法术**：当特性表「准备法术」列数字增加时，从该职业法术列表中**选择额外法术准备**直至数量与表一致，且所选法术环阶不得超过当前拥有法术位对应的环阶（例如 3 级牧师可准备一环或二环）。
  - **法师**：法术书 1 级 6 道，之后**每级 +2 道**（= 2×level + 4）；升级时从法师列表 + 当前法术位环阶中选 2 道加入法术书；准备法术从法术书中选，数量按表。
  - **魔契师**：契约魔法——法术位数量与环阶见「法术位」「法术位环阶」列（短休/长休恢复）；**玄奥秘法**在 11/13/15/17 级各选一道 6/7/8/9 环法术，每日一次不耗法术位施展，需单独存储（如 `mysticArcanum`）。
- 法术列表筛选：按 `Spell.classes` 含当前职业且 `Spell.level <= 当前开放最高环位`；依赖 2.5 中 2～9 环数据。

### 3.4 属性值提升 / 专长（ASI）

- **获得等级**（据 `职业.md` 各职业特性表「属性值提升」出现等级）：
  - **战士**：4、6、8、12、14、16 级（共 6 次）。
  - **游荡者**：4、8、10、12、16 级（共 5 次）。
  - **其余 10 职业**：4、8、12、16 级；另在 **19 级** 获得「传奇恩惠」专长（或其它适用专长），不再获得普通 ASI。
- 在对应等级提供「属性值提升专长（第五章）」或「其他满足条件的专长」二选一（或 2024 规则下的多选）。
- 若选属性提升：可选两项各 +1，或一项 +2（上限 20），写回 `abilities`。
- 若选专长：从 `feats-data` 中允许的专长列表选一个，加入 `character.feats`。

---

## 四、前端：升级向导流程

建议在 `app/characters/[id]/level-up/page.tsx` 内实现多步骤向导（或拆成子组件）：

1. **确认升级**  
   显示当前等级、下一等级；若已达 20 级则不可继续。（单职：本级即当前职业升一级。）

2. **生命值**  
   选择「掷骰」或「固定」；若掷骰则展示骰结果并计算新 HP，更新 `hitPoints`（及 `currentHitPoints`）。

3. **职业特性与选项**  
   - 根据职业等级表，若该级有可选项（含 3 级子职业），逐步展示并记录到 `classFeatureChoices`（或 `subclass`）。
   - 固定特性可只做说明，自动加入 `features` 或等效。

4. **法术（仅施法者）**  
   - 若新等级有新环位或更多「已知/准备」数量：展示可选法术列表（按职业 + 环位过滤），用户勾选/多选，写回 `spells`（及法师的「法术书」若单独存储）。

5. **专长/属性提升（4/8/12/16/19）**  
   若该级有属性提升或专长，展示选择并写回 `abilities` 或 `feats`。

6. **确认并保存**  
   汇总变更，调用 API 更新角色（见下节）。

---

## 五、兼职（Multiclassing）——据 `兼职 Multiclassing.md`

若支持「升级时选择获得新职业等级而非当前职业等级」，需实现以下规则。

### 5.1 先决条件

- 新职业与**当前已有每一职业**的主要属性均 ≥13。例如兼职德鲁伊的野蛮人需力量≥13 且感知≥13。
- 角色模型需支持**多职业等级**，例如 `classLevels: { barbarian: 5, druid: 2 }` 或 `levels: [{ class: 'barbarian', level: 5 }, { class: 'druid', level: 2 }]`，总等级 = 各职业等级之和。

### 5.2 升级时获得的内容（首级 vs 升级）

- **在某一职业上获得第一个等级时**（兼职入门）：只获得该职业「作为兼职角色」所列内容（见 `职业.md` 各职业「作为兼职角色」），例如生命值骰、部分武器/护甲熟练、**不**包含完整起始装备。
- **在同一职业上获得 2 级及以后**：按该职业特性表获得对应等级的特性（含 3 级子职业等）。

### 5.3 通用规则

- **经验值 / 总等级**：升级所需 XP 按**角色总等级**查表，而非单职业等级。
- **熟练加值**：按**角色总等级**计算（与单职相同公式）。
- **生命值**：新职业首级（兼职入门）按「1 级之后」规则，即 1 个该职业生命骰 + 体质调整值（非最大值）；同职业 2 级起同单职（掷骰或固定值）。
- **生命骰池**：所有职业的生命骰合并；同类型可合并计数（如战士 d10 + 圣武士 d10 = 若干 d10）。
- **护甲等级**：多种计算方式（如武僧无甲防御、龙族术士体魄）**只能选一种**同时使用。
- **额外攻击**：多职业的「额外攻击」**不叠加**；仅战士的「额外攻击（二）（三）」可把攻击次数提到 3/4 次。

### 5.4 兼职施法

- **法术位**：按「兼职施法者」表（见 `兼职 Multiclassing.md`）。  
  有效等级 = 吟游诗人+牧师+德鲁伊+术士+法师等级 + ⌈圣武士/游侠等级/2⌉ + 若有奥法骑士则 ⌊战士等级/3⌋ + 若有诡术师则 ⌊游荡者等级/3⌋，再查表中该等级对应的各环法术位。
- **准备法术**：**按职业分别**计算，如同该职业单职。例如 4 游侠/3 术士：游侠准备 5 个一环游侠法术，术士准备 6 个一环或二环术士法术；各用各自施法属性。
- **戏法**：若戏法随等级强化（如伤害 5/11/17 级），按**角色总等级**计算。
- **契约魔法 + 施法**：同时拥有魔契师契约魔法与其它施法时，契约法术位可用来放其它职业法术，施法职业的法术位也可用来放魔契师法术。

### 5.5 数据与 UI 影响

- 角色需存储多职业等级（及每职业子职业、每职业准备法术等）。
- 升级向导需支持「本级加在哪个职业」选择；若选新职业则校验先决条件并应用「兼职入门」熟练与生命值。
- 施法位与准备数需按兼职公式与分职业规则分别计算，再汇总展示。

---

## 六、API 与持久化

- **方案 A**：`PATCH /api/characters/[id]`，提交完整或部分角色 JSON（含 `level`、`hitPoints`、`classFeatureChoices`、`subclass`、`spells`、`feats`、`abilities` 等）。  
- **方案 B**：`POST /api/characters/[id]/level-up`，请求体为「升级结果」（新等级、HP 变更、本次选择），由服务端在现有角色上合并并校验（如等级仅 +1、子职业仅 3 级等），再写库。  

推荐 **方案 B** 更利于校验与审计；若先快速落地可用方案 A，后续再封装为 B。

---

## 七、实施阶段建议（单职，暂不考虑兼职）

以下按推荐实施顺序排列；法术 2～9 环数据已就绪（docs 生成并接入），无需再做「数据补全」阶段。

| 阶段 | 内容 | 优先级 |
|------|------|--------|
| **阶段 1** | **数据层**：职业等级表（1～5 级，可逐步到 20 级）+ 子职业数据（12 职业×3 级选项）；角色模型增加 `subclass` 或统一用 `classFeatureChoices.subclass` | 高 |
| **阶段 2** | **工具与扩展**：按职业+环位筛选法术（如 `getSpellsForClassUpToLevel(className, level)`）；魔契师玄奥秘法字段 `mysticArcanum`（11/13/15/17 级 6/7/8/9 环各一道）的存储与展示约定 | 高 |
| **阶段 3** | **升级向导 UI**：步骤 1～3——确认升级（当前/下一级）、生命值（掷骰或固定）、职业特性与选项（含 3 级子职业选择）；写回 `level`、`hitPoints`、`classFeatureChoices`/`subclass` | 高 |
| **阶段 4** | **施法者升级**：根据 `getSpellcastingRules(class, level)` 展示新环位/新准备数；可选法术列表（按职业+环位筛选）；戏法替换/新增（4、10 级）；法师法术书 +2、魔契师玄奥秘法选择；写回 `spells` 等 | 高 |
| **阶段 5** | **ASI/专长**：4/8/12/16（及战士 6/14、游荡者 10）、19 级传奇恩惠；属性提升或专长选择；写回 `abilities` 或 `feats`；职业等级表补全至 6～20 级 | 中 |
| **阶段 6** | **打磨与校验**：升级前后校验（等级 +1、3 级必有子职业、施法数量与表一致等）；API 采用 PATCH 或专用 level-up 接口；角色卡页展示子职业与最新法术/环位 | 中 |

**后续（不纳入当前单职范围）**：兼职——多职业等级、先决条件、兼职施法者表、升级时选择目标职业。

---

## 八、参考与注意事项

- **规则依据**：项目内 `职业.md`（各职业特性表、子职名称、施法表、戏法/准备法术/法师法术书/魔契师玄奥秘法等）、`兼职 Multiclassing.md`（先决条件、兼职施法者表、熟练/生命骰/额外攻击不叠加等）。
- 子职业名称与 id 需与 `职业.md` 一致，与现有 `dnd-data.ts` 命名风格统一（如职业 id 英文小写）。
- 法术数据扩充时注意版权与来源标注（`source` 字段），优先使用 SRD/公开规则内的法术。
- 升级前后校验建议（单职）：等级递增 1；3 级时若职业有子职业则必有选择；施法者准备/已知法术数量与表一致且环阶不超法术位。

---

**文档版本**：v2（已按 职业.md、兼职 Multiclassing.md 修订）  
**最后更新**：2025-02-11
