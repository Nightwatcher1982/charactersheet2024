# 战役大厅（DM 跑团工具）部署说明

## 1. 代码放在哪个仓库？

**建议：继续放在当前 charactersheet2024 仓库内（与角色卡同仓）。**

- **同仓优点**：共用 JWT、同一套部署流程、版本一致、角色卡「进入战役大厅」跳转与回调无需跨仓配置；你目前 dm-campaign-service 就在仓库根目录下，推送到 GitHub 后部署脚本可一起或分开部署。
- **单独建仓**：若希望战役大厅独立发版、独立权限或完全独立 CI/CD，可再拆出；拆出后需在两个仓库分别配置 JWT_SECRET、角色卡/战役大厅的 API 与前端 URL，部署与回滚要协调两处。

**结论**：未同步到 GitHub 的战役大厅代码，建议先以当前方式推送到 charactersheet2024 仓库；若未来要拆仓再迁移即可。

---

## 2. 域名与访问路径

当前角色卡：**https://cs.dimvision.xyz/**（子域名根路径）。

战役大厅有两种常见做法：

| 方案 | 地址示例 | 说明 |
|------|----------|------|
| **A. 新子域（推荐）** | **https://campaign.dimvision.xyz/** | 单独子域指向战役大厅服务；Nginx 反代到本机 3002；无需改 Next basePath，配置简单。 |
| **B. 同域子路径** | **https://cs.dimvision.xyz/campaigns/** | 同一域名下 `/campaigns/` 由 Nginx 反代到本机 3002；战役大厅 Next 需配置 `basePath: '/campaigns'`，静态与 API 路径都要带该前缀。 |

**推荐方案 A**：申请子域 `campaign.dimvision.xyz`（或 `dm.dimvision.xyz` 等），在 Nginx 中新增 server/server_name，反代到 `127.0.0.1:3002`，与现有 `cs.dimvision.xyz` 配置方式一致，无需改 Next 配置。

若采用方案 B，需要：
- 在战役大厅 `next.config.mjs` 中设置 `basePath: '/campaigns'`（可通过环境变量注入）；
- Nginx 中 `location /campaigns/ { proxy_pass http://127.0.0.1:3002/campaigns/; ... }`；
- 角色卡 `.env` 中 `NEXT_PUBLIC_CAMPAIGN_HALL_URL=https://cs.dimvision.xyz/campaigns/`。

---

## 3. 端口与路径对照（避免部署后访问不了）

已根据你当前本机与服务器情况整理如下。

### 本地开发

| 服务 | 端口 | 访问路径 | 说明 |
|------|------|----------|------|
| 角色卡 | **3000**（默认） | http://localhost:3000/ | 根目录 `npm run dev` |
| 战役大厅 | **3001** | http://localhost:3001/，战役列表 http://localhost:3001/campaigns/ | 在 `dm-campaign-service` 下执行 `npm run dev:3001` |

角色卡首页「进入战役大厅」默认跳转：`NEXT_PUBLIC_CAMPAIGN_HALL_URL` 未配置时等价于 `http://localhost:3001/campaigns/`。

### 服务器（阿里云）

| 服务 | 本机监听 | 对外访问 | 说明 |
|------|----------|----------|------|
| 角色卡 | **127.0.0.1:3100** | **https://cs.dimvision.xyz/** | systemd `charactersheet2024`，Nginx 反代 3100 |
| 战役大厅（计划） | **127.0.0.1:3002** | 待定（见上文方案 A/B） | 需新建 systemd 服务与 Nginx 配置 |

**已通过 SSH 确认**：服务器上 3000、3001、3002 均未被占用，角色卡实际使用 **3100**（仅 localhost），战役大厅使用 **3002** 可行。

---

## 4. 数据库使用与服务器端配置

两个服务**各自使用独立数据库**（可共用同一 PostgreSQL 实例、不同库），不要混用同一库，避免 schema 与迁移冲突。

### 4.1 角色卡（charactersheet2024）

| 项目 | 说明 |
|------|------|
| **库名** | 通常 `dnd_character_db`（由 `.env` 的 `DATABASE_URL` 决定） |
| **主要表** | User、Character、Session、VerificationCode、LoginLog、Admin、AdminAuditLog |
| **迁移目录** | 项目根目录 `prisma/migrations/` |
| **服务器** | 部署目录（如 `/opt/charactersheet2024/current`）下执行 `npx prisma migrate deploy`；systemd 已通过 `EnvironmentFile` 加载该目录 `.env` 中的 `DATABASE_URL` |

服务器端若已按《云端配置指南》配置，则已有库 `dnd_character_db` 及对应用户（如 `dnd_user`），无需再建库。

### 4.2 战役大厅（dm-campaign-service）

| 项目 | 说明 |
|------|------|
| **库名** | 建议单独库，如 `dm_campaigns`（与角色卡库**不同**） |
| **主要表** | Campaign、CampaignMember、Encounter、InitiativeEntry、CampaignEvent、CampaignDmNote、CampaignLogEntry（**无 User 表**，用户身份来自角色卡 JWT） |
| **迁移目录** | `dm-campaign-service/prisma/migrations/` |
| **服务器** | 在战役大厅部署目录（如 `/opt/dm-campaign-service/current`）下配置 `DATABASE_URL` 指向战役库，并执行 `npx prisma generate`、`npx prisma migrate deploy` |

### 4.3 服务器端：同一 PostgreSQL 实例下新建战役库（推荐）

角色卡已在服务器使用同一台机上的 PostgreSQL（如 `localhost:5432`），战役大厅建议**同实例、新库**，便于备份与权限管理。

在服务器上以 postgres 或已有管理员身份执行（密码与用户名请按实际情况替换）：

```bash
# 若沿用角色卡同一数据库用户（需该用户有建库权限或由 postgres 建库）
sudo -u postgres psql -c "CREATE DATABASE dm_campaigns OWNER dnd_user;"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE dm_campaigns TO dnd_user;"

# 若希望战役大厅单独用户（可选）
# sudo -u postgres psql -c "CREATE USER dm_user WITH ENCRYPTED PASSWORD '你的密码';"
# sudo -u postgres psql -c "CREATE DATABASE dm_campaigns OWNER dm_user;"
# sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE dm_campaigns TO dm_user;"
```

战役大厅 `.env` 中：

- 沿用同一用户时：`DATABASE_URL="postgresql://dnd_user:角色卡同密码@localhost:5432/dm_campaigns?schema=public"`
- 使用单独用户时：`DATABASE_URL="postgresql://dm_user:密码@localhost:5432/dm_campaigns?schema=public"`

**注意**：`pg_hba.conf` 若已允许 `dnd_user` 连接 `dnd_character_db`，同一 host 下连接 `dm_campaigns` 通常无需额外配置；若新建了 `dm_user`，需确保该用户可访问 `dm_campaigns`（同上 grant）。

### 4.4 迁移执行顺序（服务器部署时）

| 步骤 | 位置 | 命令 |
|------|------|------|
| 角色卡 | `/opt/charactersheet2024/current`（或当前角色卡部署目录） | `npx prisma generate && npx prisma migrate deploy` |
| 战役大厅 | `/opt/dm-campaign-service/current`（或当前战役大厅部署目录） | `npx prisma generate && npx prisma migrate deploy` |

首次部署战役大厅时，必须先创建好 `dm_campaigns` 库并配置好该目录下的 `DATABASE_URL`，再执行上述战役大厅的 migrate。之后每次发版若包含 `dm-campaign-service/prisma/migrations` 下新增迁移，部署后在同一目录再执行一次 `npx prisma migrate deploy` 即可。

---

## 6. 战役大厅使用 3002 端口

已在服务器上确认：

- 角色卡：`/etc/systemd/system/charactersheet2024.service` 中为 `ExecStart=... -p 3100 -H 127.0.0.1`，监听 **3100**。
- 3000 / 3001 / 3002 当前无其他服务占用，**战役大厅使用 3002 可行**。

建议：

- 战役大厅的 systemd 使用：`next start -p 3002 -H 127.0.0.1`（或 `Environment=PORT=3002` + `next start`），并只绑定 127.0.0.1，由 Nginx 对外提供 HTTPS。
- 本项目已在 `dm-campaign-service/package.json` 中增加 `start:3002` 脚本，便于在服务器上统一用 3002 启动。

---

## 7. 服务器 .env 配置清单与跳转链接

部署前请逐项核对，避免缺配导致登录/跳转失败。

### 7.1 角色卡（charactersheet2024）服务器 .env

| 变量 | 说明 | 服务器示例 |
|------|------|------------|
| DATABASE_URL | 角色卡 PostgreSQL | 已配置 |
| SESSION_SECRET | 会话密钥 | 已配置 |
| **JWT_SECRET** | 与战役大厅**完全一致**，用于「进入战役大厅」带 token 跳转 | 必须配置且与战役大厅相同 |
| NEXT_PUBLIC_BASE_PATH | 子路径，子域名根路径一般为空 | 空 |
| **NEXT_PUBLIC_CAMPAIGN_HALL_URL** | 首页「进入战役大厅」跳转地址（生产） | **https://campaign.dimvision.xyz/campaigns/**（方案 A）或 **https://cs.dimvision.xyz/campaigns/**（方案 B） |
| NEXT_PUBLIC_PIC_BASE_URL | 图片 OSS | 已配置 |
| 其他 | 邮件/短信等 | 按需 |

### 7.2 战役大厅（dm-campaign-service）服务器 .env

| 变量 | 说明 | 服务器示例 |
|------|------|------------|
| **JWT_SECRET** | 与角色卡**完全一致**（至少 32 字符） | 从角色卡 .env 复制 |
| **CHARACTER_SHEET_API_URL** | 服务端请求角色卡 API 的地址（拉角色列表、校验归属等） | **http://127.0.0.1:3100**（同机直连，推荐）或 https://cs.dimvision.xyz |
| **NEXT_PUBLIC_CHARACTER_SHEET_URL** | 前端「去登录」等链接（浏览器访问） | **https://cs.dimvision.xyz** |
| DATABASE_URL | 战役库 PostgreSQL（可与角色卡同实例不同库） | 如 `postgresql://user:pass@localhost:5432/dm_campaigns` |
| NEXT_PUBLIC_PIC_BASE_URL / OSS_* | 战役背景图 OSS | 与角色卡同 Bucket 时可复用 |

**跳转与回调**：

- 角色卡 → 战役大厅：首页点击「进入战役大厅」会请求 `/api/auth/me` 拿 JWT，再跳转到 `NEXT_PUBLIC_CAMPAIGN_HALL_URL` 对应的 `/campaigns/callback?token=xxx`，战役大厅存 token 后进入列表，**无需二次登录**。
- 战役大厅 → 角色卡：未登录时跳转到 `NEXT_PUBLIC_CHARACTER_SHEET_URL/login?redirect=...`，登录后带 token 回战役大厅 callback。因此生产环境务必把 `NEXT_PUBLIC_CHARACTER_SHEET_URL` 配成 **https://cs.dimvision.xyz**。

---

## 部署战役大厅的推荐步骤（方案 A：子域 campaign.dimvision.xyz）

1. **代码**：将 dm-campaign-service 随 charactersheet2024 仓库推送到 GitHub。
2. **服务器**：在合适目录 clone 或拉取（可与角色卡同仓不同目录，或同仓子目录 `dm-campaign-service`），例如 `/opt/dm-campaign-service/current`。
3. **数据库**（详见上文 **§4 数据库使用与服务器端配置**）：
   - 在服务器 PostgreSQL 中**新建库** `dm_campaigns`（与角色卡库 `dnd_character_db` 分离），并授予对应用户权限。
   - 在战役大厅部署目录配置 `.env` 中的 `DATABASE_URL` 指向 `dm_campaigns`。
   - 在战役大厅部署目录执行：`npx prisma generate && npx prisma migrate deploy`。
4. **.env**：在战役大厅目录按 §7.2 配置，尤其 JWT_SECRET、CHARACTER_SHEET_API_URL、NEXT_PUBLIC_CHARACTER_SHEET_URL、DATABASE_URL。
5. **systemd**：新建服务，例如 `dm-campaign.service`，WorkingDirectory 指向战役大厅目录，ExecStart 使用 `npm run start:3002 -- -H 127.0.0.1`，EnvironmentFile 指向该目录 .env。
6. **Nginx**：为 `campaign.dimvision.xyz` 申请证书并添加 server，`proxy_pass http://127.0.0.1:3002;`。
7. **角色卡 .env**：设置 `NEXT_PUBLIC_CAMPAIGN_HALL_URL=https://campaign.dimvision.xyz/campaigns/`，重新构建并部署角色卡前端。

完成后，用户在 https://cs.dimvision.xyz 登录后点击「进入战役大厅」会带 token 打开战役大厅，无需再次登录。

**按顺序执行的一步步清单（含你需要操作与配置的步骤）**见 [战役大厅部署执行清单.md](战役大厅部署执行清单.md)。

### 战役大厅 systemd 示例（方案 A，监听 3002）

在服务器上创建 `/etc/systemd/system/dm-campaign.service`（或 `campaign-hall.service`）：

```ini
[Unit]
Description=DM Campaign Hall (Next.js)
After=network.target

[Service]
EnvironmentFile=/opt/dm-campaign-service/current/.env
Type=simple
User=nginx
WorkingDirectory=/opt/dm-campaign-service/current
Environment=NODE_ENV=production
Environment=NEXT_TELEMETRY_DISABLED=1
ExecStart=/usr/bin/npm run start:3002 -- -H 127.0.0.1
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

然后执行：`systemctl daemon-reload && systemctl enable --now dm-campaign`。

### 部署前 .env 与数据库快速检查

- **角色卡**：`DATABASE_URL` 指向角色卡库（如 `dnd_character_db`）、`JWT_SECRET`、`NEXT_PUBLIC_CAMPAIGN_HALL_URL`（生产公网战役大厅地址）已填；服务器部署目录已执行过 `npx prisma migrate deploy`。
- **战役大厅**：`DATABASE_URL` 指向**单独**战役库（如 `dm_campaigns`，勿与角色卡同库）、`JWT_SECRET` 与角色卡一致、`CHARACTER_SHEET_API_URL`（服务端用，生产建议 `http://127.0.0.1:3100`）、`NEXT_PUBLIC_CHARACTER_SHEET_URL`（前端用，生产 `https://cs.dimvision.xyz`）已填；服务器战役大厅目录已创建好库并执行过 `npx prisma migrate deploy`。
