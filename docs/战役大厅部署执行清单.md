# 战役大厅部署执行清单（按顺序）

从「上传代码」到「配置子域名」全流程，需你操作或确认的步骤已用 **【你操作】** 标出，其余为可执行的命令或说明。

---

## 阶段一：本地准备与代码上传

### 1. 确认本地无未提交改动（可选）

```bash
cd /Users/nwdemacmini/Documents/5r\ character\ sheet
git status
```

若有未提交修改且希望一并上线，先 `git add`、`git commit`。

### 2. 推送代码到 GitHub

**【你操作】** 在项目根目录执行：

```bash
git add -A
git commit -m "feat: 战役大厅及部署脚本与文档"
git push origin main
```

若 dm-campaign-service 尚未纳入版本控制，上述会一并推送；若 push 因权限/分支失败，请按你实际使用分支（如 `main`）调整。

---

## 阶段二：服务器初次准备（仅首次部署需做）

### 3. 子域名与 DNS

**【你操作】**  

- 在域名服务商（dimvision.xyz 所在处）添加 **A 记录**：`campaign.dimvision.xyz` → 服务器公网 IP（与 `cs.dimvision.xyz` 同一台，即 `47.238.5.63`）。  
- 等待 DNS 生效（几分钟到几十分钟不等）。可本地执行：`ping campaign.dimvision.xyz` 或 `dig campaign.dimvision.xyz` 确认解析到该 IP。

### 4. 服务器上克隆仓库（战役大厅用目录）

**【你操作】** SSH 登录服务器后，在服务器上执行（若目录已存在可跳过）：

```bash
sudo mkdir -p /opt/dm-campaign-service
sudo chown "$(whoami):$(whoami)" /opt/dm-campaign-service
cd /opt/dm-campaign-service
git clone https://github.com/你的用户名/charactersheet2024.git current
# 若仓库为私有，请用 SSH 地址或配置好认证： git clone git@github.com:你的用户名/charactersheet2024.git current
```

完成后应存在目录：`/opt/dm-campaign-service/current`（仓库根）、`/opt/dm-campaign-service/current/dm-campaign-service`（战役大厅应用）。

### 5. 服务器上创建战役库

**【你操作】** 在服务器上执行（密码与用户按你当前角色卡库配置替换；若角色卡库用户为 `dnd_user`）：

```bash
sudo -u postgres psql -c "CREATE DATABASE dm_campaigns OWNER dnd_user;"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE dm_campaigns TO dnd_user;"
```

若你角色卡用的是其他数据库用户，把 `dnd_user` 换成该用户，或先创建专用用户再 `OWNER` 指向该用户。

### 6. 战役大厅 .env（服务器）

**【你操作】** 在服务器上创建并编辑战役大厅的 `.env` 文件：

```bash
cp /opt/dm-campaign-service/current/dm-campaign-service/.env.example /opt/dm-campaign-service/current/dm-campaign-service/.env
nano /opt/dm-campaign-service/current/dm-campaign-service/.env
```

必须填写或确认（值与角色卡一致或按下面说明）：

| 变量 | 值（示例） |
|------|------------|
| JWT_SECRET | 与角色卡 `.env` 中 **完全一致**（从角色卡服务器 `/opt/charactersheet2024/current/.env` 复制） |
| CHARACTER_SHEET_API_URL | `http://127.0.0.1:3100` |
| NEXT_PUBLIC_CHARACTER_SHEET_URL | `https://cs.dimvision.xyz` |
| DATABASE_URL | `postgresql://dnd_user:你的密码@localhost:5432/dm_campaigns?schema=public` |

可选：战役背景图用 OSS 时，可复用角色卡同 Bucket，按需填 `NEXT_PUBLIC_PIC_BASE_URL`、`OSS_BUCKET`、`OSS_REGION`、阿里云密钥。

保存后退出。

### 7. 战役大厅首次迁移与构建（服务器）

**【你操作】** 在服务器上执行：

```bash
cd /opt/dm-campaign-service/current/dm-campaign-service
npx prisma generate
npx prisma migrate deploy
export NEXT_TELEMETRY_DISABLED=1
npm ci
npm run build
```

确认无报错。

### 8. systemd 服务（战役大厅）

**【你操作】** 在服务器上创建并启用服务（注意：Next 的 `start` 脚本可能不认 `-H`，若启动报错可去掉 `-- -H 127.0.0.1`，仅保留 `npm run start:3002`）：

```bash
sudo tee /etc/systemd/system/dm-campaign.service << 'EOF'
[Unit]
Description=DM Campaign Hall (Next.js)
After=network.target

[Service]
EnvironmentFile=/opt/dm-campaign-service/current/dm-campaign-service/.env
Type=simple
User=nginx
WorkingDirectory=/opt/dm-campaign-service/current/dm-campaign-service
Environment=NODE_ENV=production
Environment=NEXT_TELEMETRY_DISABLED=1
ExecStart=/usr/bin/npm run start:3002 -- -H 127.0.0.1
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF
```

若服务器上运行角色卡的用户不是 `nginx`，把 `User=nginx` 改成该用户（与角色卡 systemd 一致即可）。

然后执行：

```bash
sudo systemctl daemon-reload
sudo systemctl enable dm-campaign
sudo systemctl start dm-campaign
sudo systemctl status dm-campaign
```

确认状态为 `active (running)`，且本机 `curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3002/campaigns` 返回 302 或 200。

### 9. Nginx + HTTPS（子域 campaign.dimvision.xyz）

**【你操作】** 在服务器上新增 Nginx 配置（先 HTTP，再申请证书）：

```bash
sudo tee /etc/nginx/conf.d/campaign.dimvision.xyz.conf << 'EOF'
# 战役大厅子域（先 HTTP，证书用 certbot 申请后会自动改）
server {
    server_name campaign.dimvision.xyz;
    location / {
        proxy_pass http://127.0.0.1:3002;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
    listen 80;
}
EOF
```

重载 Nginx 并申请证书：

```bash
sudo nginx -t && sudo systemctl reload nginx
sudo certbot --nginx -d campaign.dimvision.xyz
```

按提示完成证书申请后，Nginx 会自动改为 443 并重定向 80→443。

### 10. 角色卡 .env 增加战役大厅跳转地址

**【你操作】** 在**服务器**上编辑角色卡项目的 `.env`（路径以你实际为准，例如 `/opt/charactersheet2024/current/.env`），新增或修改：

```env
NEXT_PUBLIC_CAMPAIGN_HALL_URL="https://campaign.dimvision.xyz/campaigns/"
```

并确认角色卡 `.env` 中已有 **JWT_SECRET**（与战役大厅完全一致）。保存后需要**重新构建并部署角色卡**，该变量才会生效（见下一步）。

### 11. 重新部署角色卡（使「进入战役大厅」指向生产）

**【你操作】** 在**你本机**项目根目录执行现有角色卡部署脚本（会 push + 服务器拉代码 + build + 重启）：

```bash
cd /Users/nwdemacmini/Documents/5r\ character\ sheet
bash scripts/deploy-aliyun.sh
```

这样角色卡前端会带上 `NEXT_PUBLIC_CAMPAIGN_HALL_URL=https://campaign.dimvision.xyz/campaigns/`，首页「进入战役大厅」会跳到新子域。

---

## 阶段三：验证与后续更新

### 12. 功能自测

**【你操作】** 在浏览器中：

1. 打开 https://cs.dimvision.xyz ，登录账号。  
2. 点击首页「进入战役大厅」，应跳转到 https://campaign.dimvision.xyz/campaigns/ 且**无需再次登录**。  
3. 在战役大厅可创建战役、邀请等，按需简单走一遍流程。

### 13. 之后每次只更新战役大厅代码时

在**本机**执行（已写好脚本，会 push + 服务器拉取 + 在 `dm-campaign-service` 下 npm ci、prisma generate、build、migrate、重启服务）：

```bash
bash scripts/deploy-aliyun-campaign.sh
```

无需再改 Nginx、systemd、.env（除非你要改端口或域名）。

---

## 简要顺序小结

| 序号 | 内容 | 谁做 |
|------|------|------|
| 1 | 本地 git 提交并 push 到 GitHub | 你 |
| 2 | DNS：campaign.dimvision.xyz → 服务器 IP | 你 |
| 3 | 服务器 clone 仓库到 /opt/dm-campaign-service/current | 你 |
| 4 | 服务器创建库 dm_campaigns、授权 | 你 |
| 5 | 服务器战役大厅 .env 配置 | 你 |
| 6 | 服务器战役大厅 prisma migrate + npm ci + build | 你 |
| 7 | 服务器 systemd dm-campaign 服务创建并启动 | 你 |
| 8 | 服务器 Nginx 配置 + certbot 证书 | 你 |
| 9 | 服务器角色卡 .env 增加 NEXT_PUBLIC_CAMPAIGN_HALL_URL | 你 |
| 10 | 本机执行 deploy-aliyun.sh 重新部署角色卡 | 你 |
| 11 | 浏览器验证：cs 登录 → 进入战役大厅 → 免登 | 你 |
| 12 | 以后只更新战役大厅：本机执行 deploy-aliyun-campaign.sh | 你/脚本 |

到「你操作」和「更新配置」的步骤时，按上面对应小节执行即可；若某步已做过（例如仓库已 clone、证书已存在），可跳过。
