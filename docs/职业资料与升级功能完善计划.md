# 职业资料与升级功能完善计划

## 一、目标

将 `docs/DND资料/` 下 12 个职业 Markdown 中的**职业特性、子职业特性及各类选择**结构化入库，并在**升级流程**中通过弹窗/步骤让玩家完成所有「获得时需选择」的项（如专精技能、属性值提升、子职法术自动加入、地形选择、魔能祈唤等），最终完善「升级」功能。

---

## 二、资料中的「技能/特性」分类

根据已阅读的德鲁伊、法师、吟游诗人、魔契师、牧师、野蛮人、战士等文档，可归纳为以下几类。

### 2.1 按归属分类

| 类型 | 说明 | 示例 |
|------|------|------|
| **职业基础特性** | 所有该职业在指定等级获得的固定能力 | 狂暴、施法、专精、万事通、荒野变形 |
| **子职业特性** | 选择某子职后在指定等级获得的固定能力 | 月亮结社·结社形态、生命领域·生命门徒 |
| **子职业法术表** | 选择某子职后，在指定等级「始终准备」的法术列表 | 月亮结社法术、生命领域法术、大地结社法术（按地形） |

### 2.2 按是否触发玩家选择分类

| 类型 | 说明 | 触发时机 | 当前/目标 |
|------|------|----------|-----------|
| **子职业选择** | 3 级选一个子职 | 升级到 3 级 | ✅ 已有步骤 |
| **专精（技能）** | 从熟练技能中选 N 项获得专精 | 获得「专精」特性的等级（如诗人 2/9、游荡者 1/6） | ✅ 已有步骤 |
| **属性值提升/专长** | +2 单属性或 +1 两属性或选专长 | 4/8/12/16/19（及战士 6/14 等） | ✅ 已有 ASI 步骤 |
| **子职法术自动加入** | 子职法术表：到达某等级即「始终准备」表中法术，**无需玩家选，但需写入角色法术列表** | 选择子职后，到达表中对应等级时 | ❌ 需新增：升级时检测并自动追加 |
| **地形/选项选择** | 大地结社选地形（荒漠/极地/温带/热带），决定结社法术表 | 德鲁伊 3 级选大地结社时 | ❌ 需新增弹窗 |
| **法师学派法术入书** | 防护师等：免费将若干学派法术加入法术书 | 法师 3 级选学派时 | ❌ 需新增：选学派后自动加法术 |
| **魔能祈唤** | 魔契师每级可选/替换祈唤 | 1 级及每次魔契师升级 | ❌ 需新增弹窗 |
| **玄奥秘法** | 魔契师 11/13/15/17 级各选一道 6/7/8/9 环法术 | 对应等级 | ✅ 有 mysticArcanum 字段，需升级步骤选法术 |
| **战斗风格** | 战士 1 级等选战斗风格专长 | 1 级或升级时替换 | ❌ 可选：创建时/升级时选 |
| **原初学识** | 野蛮人 3 级：从野蛮人技能列表再选 1 项熟练 | 3 级 | ❌ 需新增 |
| **学者（专精）** | 法师 2 级：从指定技能中选 1 项获得专精 | 2 级 | ❌ 需新增（与诗人专精类似） |
| **施法职业常规法术** | 升级时准备法术数量增加，需「选择新法术」或「替换一道」 | 每次施法者升级 | ❌ 需新增：选择新习得/准备的法术 |

### 2.3 子职业法术表结构（需入库）

- **德鲁伊**  
  - 大地结社：按**地形**（荒漠/极地/温带/热带）分表，每地形 3/5/7/9 级对应不同法术。  
  - 月亮结社：固定表，3/5/7/9 级对应法术。  
  - 海洋结社：固定表，3/5/7/9 级。  
  - 星辰结社：无「结社法术表」，而是星图、星耀形态等。
- **牧师**  
  - 生命/光明/诡术/战争领域：各有一张「领域法术」表，3/5/7/9 级对应法术。
- **法师**  
  - 防护师等：3 级免费加入 2 道不高于二环的学派法术入书；之后每新环阶可再免费加 1 道学派法术。
- **圣武士/魔契师/术士**  
  - 各子职 similarly 有「誓约法术」「宗主法术」等表，需在文档中逐一定位并归纳。

---

## 三、数据层设计

### 3.1 现有数据结构（沿用）

- **职业等级表**：`lib/class-level-table.ts`（每级特性 id + 选项 id，如 subclass、ability-score-improvement）。
- **子职业列表**：`lib/subclass-data.ts`（id、name、classId、levelGained）。
- **职业特性详情**：`lib/class-features-data.ts`（level1Features、featuresByLevel）。
- **角色**：`character.class`、`character.subclass`、`character.classFeatureChoices`、`character.spells`、`character.mysticArcanum` 等。

### 3.2 需要新增/扩展的数据

| 数据 | 用途 | 建议位置 |
|------|------|----------|
| **子职业法术表** | 按 classId+subclassId+等级 → 法术 id 列表（或中文名到 id 的映射） | 新文件 `lib/subclass-spells-data.ts` 或合并进 subclass-data |
| **大地结社地形选项** | 地形 id → 名称 + 各等级法术列表 | 同上或 `lib/druid-land-spells.ts` |
| **法师学派免费入书法术** | 学派 id → 2 道二环内法术 + 各环阶 1 道可选 | `lib/wizard-school-spells.ts` 或 class-features-data |
| **等级→选择类型映射** | 某职业某等级需要弹窗的类型：expertise / asi / subclass_spells / land_terrain / invocations / mystic_arcanum / new_spells 等 | 可在 class-level-table 的 choices 中扩展，或单独 `lib/level-choice-types.ts` |

### 3.3 法术名称与 id 的对应

- 文档中使用中文名 + 英文名（如「疗伤术Cure Wounds」「月华之光Moonbeam」）。
- 现有法术数据在 `lib/spells-from-docs.generated.ts` / `lib/spells-data.ts` 中，id 多为英文小写+连字符（如 `cure-wounds`、`moonbeam`）。
- 脚本或数据需建立「中文名/英文名 → spell id」的映射，用于子职业法术表、法师学派法术等写入角色。

---

## 四、脚本设计：从文档到数据

### 4.1 解析范围

- **输入**：`docs/DND资料/*.md`（12 个职业）。
- **输出**：  
  - 不改变现有「等级表」的解析逻辑，仅**补充**子职业相关结构化数据。  
  - 可生成/更新：  
    - 子职业法术表（含德鲁伊大地结社按地形）；  
    - 法师学派免费法术；  
    - 各职业「等级 → 需触发的选择类型」配置（用于前端步骤/弹窗）。

### 4.2 解析策略

1. **按文件、按标题层级解析**  
   - 识别「X级：特性名」作为等级特性。  
   - 识别「子职名 + 法术」表（如「月亮结社法术」「生命领域法术」），表格行：等级 + 法术名（中英）。  
   - 大地结社：先解析地形（荒漠/极地/温带/热带），再解析每个地形下等级→法术。

2. **法术名 → id**  
   - 从 `ALL_SPELLS_FROM_DOCS` / 现有法术列表生成「中文名→id」「nameEn→id」映射；  
   - 解析到「疗伤术」「Cure Wounds」时解析为 `cure-wounds`，无法匹配的记入日志或 fallback 到原文。

3. **输出格式**  
   - 建议输出为 TypeScript 模块（如 `lib/subclass-spells.generated.ts`），便于与现有 `class-level-table`、`subclass-data` 一起被升级流程和角色卡使用。

### 4.3 脚本步骤（建议顺序）

1. 实现 Markdown 解析：按职业文件、标题、表格提取「等级」「特性名」「法术名」等。  
2. 实现法术名→id 解析（依赖现有 spells 数据）。  
3. 生成「子职业 + 等级 → 法术 id[]」结构（含大地结社地形分支）。  
4. 生成「法师学派 → 免费入书法术」结构。  
5. （可选）生成「等级 → 选择类型」配置表，供前端升级向导使用。

---

## 五、升级流程与弹窗/步骤

### 5.1 现有升级步骤（保留）

- 步骤 0：确认升级  
- 步骤 1：生命值  
- 步骤 2：职业特性与子职业（3 级选子职）  
- 步骤 3：等级选择（专精、ASI）

### 5.2 需要新增或扩展的触发点

| 触发条件 | 行为 | 实现方式建议 |
|----------|------|-----------------------------|
| 本等级获得「专精」 | 从熟练技能中选 N 项 | ✅ 已有（步骤 3） |
| 本等级获得「属性值提升」 | 选属性 +2 或专长 | ✅ 已有（步骤 3） |
| 本等级为 3 且选择**大地结社** | 先选地形（荒漠/极地/温带/热带），再根据地形自动加入对应结社法术 | 步骤 2 子职选择后，若 subclass=land，弹出「选择地形」；确定后调用逻辑写入法术列表 |
| 本等级为 3 且选择**月亮/海洋结社** | 无需选地形，直接根据「子职业法术表」将当前等级及之前等级对应的法术加入角色「始终准备」或 spells | 步骤 3 或「完成升级」前：根据 character.subclass + newLevel 查表，merge 到 character.spells 或 prepared |
| 牧师 3 级选领域后 | 同子职法术表，按领域+等级加入领域法术 | 同德鲁伊子职法术 |
| 法师 3 级选学派后 | 免费 2 道二环内学派法术入书；之后每新环阶 1 道学派法术入书 | 选学派后弹窗或自动：将规定法术 id 加入法师「法术书」数据（若当前有该字段） |
| 魔契师 1 级及每次升级 | 选择/替换魔能祈唤 | 新步骤或步骤 3 内「魔能祈唤」区块：多选/替换，写入 classFeatureChoices.invocations |
| 魔契师 11/13/15/17 级 | 选择一道 6/7/8/9 环法术作为玄奥秘法 | 步骤 3 或单独步骤：下拉/搜索选法术，写入 character.mysticArcanum.level6/7/8/9 |
| 施法者任意升级 | 准备法术数量增加：从职业法术列表选 1 道（或替换 1 道） | 步骤 3 或新步骤：「选择新准备法术」弹窗，写入 spells / prepared |

### 5.3 子职业法术「自动加入」逻辑

- 在**完成升级**或**步骤 3 提交**时：  
  - 若 `character.subclass` 已定（含刚在步骤 2 选的），且存在「子职业法术表」：  
    - 查表得到「该子职在 1～newLevel 之间所有等级」对应的法术 id 列表；  
    - 与现有 `character.spells`（或 prepared 列表）合并去重后写回。  
- 这样「月亮结社 3 级」会得到 3 级一行中的法术；5 级再升级会再追加 5 级一行中的法术，无需玩家逐个点选，但数据一致且可展示在角色卡上。

---

## 六、实施阶段建议

| 阶段 | 内容 | 产出 |
|------|------|------|
| **阶段 A** | 设计并实现「法术名→id」映射 + 子职业法术表解析脚本（仅解析，先不覆盖现有数据） | 脚本 + 生成的 subclass-spells 等 TS 草稿 |
| **阶段 B** | 正式生成并接入 `subclass-spells-data.ts`（含大地结社地形）、法师学派法术数据；角色数据结构中支持「始终准备」或扩展 spells 存储 | 数据层就绪 |
| **阶段 C** | 升级流程：子职法术自动追加（选子职/升级完成时）；大地结社地形选择弹窗 | 德鲁伊/牧师等子职法术在升级后正确进入角色卡 |
| **阶段 D** | 魔契师：魔能祈唤选择弹窗 + 玄奥秘法选择（11/13/15/17）；法师：学派法术入书 | 升级时选择与数据写回 |
| **阶段 E** | 施法者通用：升级时「选择新准备/已知法术」弹窗 | 每次升级都可选新法术 |
| **阶段 F** | 其余选择（原初学识、学者专精、战斗风格等）按需加步骤或弹窗 | 升级功能基本完善 |

---

## 七、小结

- **资料**：12 个职业文档中的特性与子职业法术表需按「等级、子职、地形（仅大地结社）」分类整理，并通过**脚本**解析为结构化数据（子职业法术表、学派法术等），与现有法术 id 对齐。  
- **数据库**：不另建外部数据库，用 TypeScript 模块（如 `subclass-spells-data.ts`、扩展 `class-features-data` 等）作为「库」，由升级流程与角色卡读取。  
- **升级与弹窗**：所有「获得时需选择」的项（专精、ASI、子职、地形、祈唤、玄奥秘法、新法术等）都通过**升级向导步骤或弹窗**让玩家选择；「子职法术表」在选子职/升级完成时**自动追加**到角色法术列表，无需玩家逐条选择。  

按上述阶段推进，即可在保留现有升级流程的基础上，把文档中的子职业技能与法术全部接入，并让升级功能覆盖所有关键选择与自动加成。
