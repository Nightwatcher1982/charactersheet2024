# 会员制与收费平台调研

本文档面向「基础版分支独立 + 会员专属分支 + 创作者收费平台选型与接入」的调研结论与改造要点。

---

## 一、版本与分支策略

### 1.1 当前作为基础版本并独立分支

**建议做法：**

- 在**当前功能稳定**的节点打 tag（如 `v1.0-base`），并拉出长期维护分支，例如 `base` 或 `maintenance`。
- **基础版**只做：
  - Bug 修复、安全补丁、依赖升级。
  - 可选：少量无争议的「基础功能」（如无障碍、性能优化），按需合并，避免与会员版功能耦合。
- **会员版**从该 tag/分支再拉新分支（如 `member` 或 `premium`），在会员分支上开发：
  - 角色升级、更丰富法术库、武器装备管理等会员专属功能。
  - 与收费平台（如爱发电）的对接逻辑也仅存在于会员分支，保持基础版简洁。

**分支关系示意：**

```
main (或 release) ← 当前稳定代码，打 tag v1.0-base
  ├── base / maintenance   ← 基础版长期维护（只修 bug / 小改进）
  └── member / premium    ← 会员版：在 v1.0-base 上增加会员功能 + 收费对接
```

这样做的效果：基础版可独立部署、独立发版；会员版在基础版之上叠加，减少两套代码的长期分叉。

### 1.2 会员专属分支可规划的功能（简述）

- 角色升级、经验与等级体系。
- 更丰富的法术库、武器装备管理与检索。
- 其他「仅会员可见/可用」的页面与 API。
- 会员身份与权益与收费平台（爱发电等）同步，见下文第四节。

---

## 二、创作者友好型收费平台调研（会员制 + 微信/支付宝）

以下平台均支持或可支持**月度/定期订阅**、**创作者自主定价**，且对个人创作者相对友好。支付方式以国内常见方式（微信、支付宝等）为主。

| 平台     | 会员/订阅     | 支付方式           | 创作者分成/费率     | 特点简述 |
|----------|---------------|--------------------|---------------------|----------|
| **爱发电** | 多档位月度订阅 | 微信、支付宝       | 约 94%（平台约 6% + 支付约 1%） | 会员制成熟，有 Webhook + API + OAuth2，适合「站点 + 会员权益」联动。 |
| **冲呀**   | 订阅制         | 微信、支付宝       | 约 87%（平台 12% + 支付 1%）   | 粉丝支持向，订阅与内容发布。 |
| **爱赞助** | 月/年订阅      | 支付宝等           | 约 92%（平台 8%，支付宝提现免手续费） | 付费内容订阅，图片/音视频。 |
| **面包多** | 内容售卖 + Pay | 微信、支付宝       | 约 94%（约 5% + 支付约 1%）；面包多 Pay 约 2%+0.1 元 | 数字内容 + 独立支付能力，有 API/Webhook，可做自助订阅。 |
| **小报童** | 订阅/买断      | 微信等             | 约 79%（服务费 15% + 提现约 6.1%） | 适合专栏/长期读者关系，偏内容。 |
| **知识星球** | 星球会员       | 微信等             | 需查最新规则         | 社区 + 内容，偏社群。 |

**与您需求（月度会员、微信/支付宝、创作者友好）最匹配的：**

- **首选：爱发电**  
  - 会员档位、月度订阅成熟，微信/支付宝支持完善。  
  - 文档齐全：Webhook（订单回调）、开放 API（查订单、查赞助者）、OAuth2（用户关联授权），便于和本站账号体系打通并自动开通/续期/过期会员。

- **备选：面包多 / 面包多 Pay**  
  - 费率有优势，面包多 Pay 提供支付 API + Webhook，若希望更深度自建订阅与站点集成，可考虑。

- **冲呀、爱赞助**  
  - 若更看重「粉丝打赏/订阅」形态、对 API 要求不高，可作为补充或对比。

---

## 三、爱发电能力小结（与接入强相关）

- **Webhook**  
  - 在 [开发者后台](https://afdian.net/dashboard/dev) 配置通知 URL。  
  - 有订单时平台 POST 到该 URL，payload 含 `data.type === 'order'` 及订单详情（`out_trade_no`、`user_id`、`user_private_id`、`plan_id`、`month`、`total_amount`、`status` 等）。  
  - `status === 2` 表示交易成功。  
  - 响应需返回 `{"ec": 200}`，且建议做**幂等**（同一订单可能重复推送）。

- **开放 API（签名：user_id + params + ts + sign，token 仅参与签名）**  
  - 查订单：`query-order`（分页、按订单号等）。  
  - 查赞助者：`query-sponsor`（分页，含当前方案、赞助关系建立时间等）。  
  - 用于：校验用户是否赞助、补漏 Webhook、定时同步会员状态。

- **OAuth2 关联授权**  
  - 授权码模式，回调后用 `code` 换 `user_id`、`user_private_id`（无长期 access_token）。  
  - 用途：让**本站用户**在站内「绑定爱发电账号」，得到爱发电 `user_id`，与本站 `User` 关联，便于把 Webhook 里的付款人对应到本站账号并开通/续期会员。

- **发电有效期**  
  - 赞助 1 个月 ≈ 31 天权益；可据此在本站维护会员到期时间（见下节）。

---

## 四、当前代码与用户机制如何接入爱发电（及改造点）

### 4.1 当前项目已具备、可直接复用的部分

- **用户与角色**  
  - `User.role` 已为 `normal | member`，且已有 `requireMember()`（`lib/auth.ts`），会员专属 API 只需在路由中调用 `requireMember()` 即可。  
  - 管理员已在后台可修改用户等级（`PUT /api/admin/users/[id]/role`），适合手动兜底或测试。

- **会话与鉴权**  
  - 邮箱登录、Session（iron-session）、`requireAuth()` 已就绪；会员分支只需在「需要会员的接口」用 `requireMember()` 替代 `requireAuth()`。

- **前端**  
  - 设置页等已展示 `role === 'member' ? '会员' : '普通用户'`，会员分支可在此基础上增加「绑定爱发电」「会员到期时间」等展示与跳转。

因此，**会员状态判断与鉴权**无需大改，主要工作是：**把爱发电的「付费/赞助」与本站 User 关联，并维护会员状态与有效期**。

### 4.2 需要新增的数据与接口

| 项目 | 说明 |
|------|------|
| **User 表扩展** | 建议在会员分支中增加字段（Prisma 迁移）：<br>• `afdianUserId String? @unique` — 爱发电 user_id，OAuth 绑定后写入。<br>• `memberExpiresAt DateTime?` — 会员到期时间（可选；若只做「当前是否赞助」可由 API 实时查，也可用此字段做缓存并配合定时任务更新）。 |
| **绑定爱发电** | • 提供「绑定爱发电」入口：跳转爱发电 OAuth2 授权页，回调后用 code 换 user_id，更新当前登录用户的 `afdianUserId`。<br>• 需要爱发电开发者后台申请 OAuth2（应用名、可信域名、client_secret），并配置 redirect_uri。 |
| **Webhook 接收** | • 新增接口，如 `POST /api/webhooks/afdian`。<br>• 校验请求来源（若爱发电提供签名/密钥则校验），解析 body，若 `data.type === 'order'` 且 `data.order.status === 2`：<br>  - 用 `data.order.user_id` 查本站 `User.afdianUserId`，找到则将该用户 `role = 'member'`，并按 `month` 更新 `memberExpiresAt`（例如 +31 天）。<br>• 响应 `{"ec":200}`，并做幂等（同一 `out_trade_no` 只处理一次）。 |
| **会员过期** | • 方案 A：定时任务（如 cron）按 `memberExpiresAt` 将已过期用户的 `role` 改回 `normal`（可选：同时清空 `memberExpiresAt`）。<br>• 方案 B：在 `requireMember()` 或中间件中若发现 `memberExpiresAt < now` 则视为非会员并拒绝，同时可异步更新 `role`。 |
| **API 查赞助者补漏** | • 可选：定时调用爱发电「查赞助者」API，与本站 `User.afdianUserId` 对照，同步仍为赞助中的用户的 `role` 与 `memberExpiresAt`，防止 Webhook 漏推。 |

### 4.3 接入流程简述（用户侧）

1. 用户在本站注册/登录（现有流程）。
2. 用户前往爱发电赞助你的创作者账号（站外完成支付）。
3. 用户回到本站，在「设置」或「会员」页点击「绑定爱发电」→ 跳转爱发电 OAuth2 → 授权后回调本站，本站写入 `afdianUserId`。
4. 爱发电向本站 Webhook 推送订单（或本站定时拉取赞助者列表），本站根据 `user_id` 找到对应用户，将其设为会员并更新到期时间。
5. 用户访问会员专属功能时，`requireMember()` 校验 `role === 'member'`（及可选 `memberExpiresAt`），通过即可使用。

### 4.4 若选用其他平台（面包多、冲呀等）

- **面包多 Pay**：有 Webhook 与支付 API，需自建「订阅/会员」业务逻辑（例如：某商品或某金额对应 1 个月会员），并在本站用「订单回调」更新 `User.role` 与 `memberExpiresAt`；需在 User 上存「面包多用户/订单」关联字段。
- **冲呀 / 爱赞助**：若平台提供 Webhook 或开放 API，思路同上：用平台用户标识与本站 User 关联，在支付/续费回调中更新会员状态；若无 API，则只能手动在后台改用户等级，或让用户提供凭证人工核对。

爱发电的优势在于：**Webhook + 查订单/查赞助者 API + OAuth2 绑定** 三者齐全，和当前「邮箱登录 + User.role」的架构对接成本最低。

---

## 五、小结与建议

1. **分支**：当前版本打 tag 并独立为「基础版」长期分支；会员功能与收费对接放在「会员版」分支，基于该 tag 开发。
2. **收费平台**：优先选用**爱发电**实现月度会员制、微信/支付宝收款；备选面包多/冲呀等，按是否需要 API 深度集成决定。
3. **接入改造**：  
   - 数据：User 增加 `afdianUserId`、`memberExpiresAt`（仅会员分支）。  
   - 后端：爱发电 Webhook 接口、OAuth2 绑定流程、可选定时同步与过期处理。  
   - 前端：绑定爱发电入口、会员状态/到期展示；会员专属功能路由继续使用现有 `requireMember()`。  

按上述方式，当前代码与用户管理机制可以较方便地接入爱发电的收费会员体系，其余平台可在此基础上做差异化适配（主要是关联字段与回调逻辑）。
