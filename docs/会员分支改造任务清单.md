# 会员分支改造任务清单

本文档按**文件/API**拆分为可执行步骤，便于在会员分支（如 `member` / `premium`）上逐项实现。依赖关系已排序，建议按顺序执行。

---

## 前置条件

- 已在爱发电 [开发者后台](https://afdian.net/dashboard/dev) 申请并获取：
  - **user_id**、**api_token**（用于 API 签名与 Webhook 校验，若平台支持）
  - **OAuth2**：client_id、client_secret、已配置 redirect_uri
- 代码库已从 `v1.0-base`（或当前稳定 tag）拉出会员分支。

---

## 阶段 0：分支与 Tag（可选，若尚未做）

| 序号 | 任务 | 操作 |
|------|------|------|
| 0.1 | 打基础版 tag | `git tag v1.0-base`（在 main 当前提交） |
| 0.2 | 拉基础版维护分支 | `git checkout -b base v1.0-base`，推送后切回 main |
| 0.3 | 拉会员分支 | `git checkout -b member v1.0-base`（后续改造均在此分支） |

---

## 阶段 1：数据层

### 1.1 Prisma Schema

| 序号 | 文件 | 任务 |
|------|------|------|
| 1.1 | `prisma/schema.prisma` | 在 `User` 模型中新增字段：<br>• `afdianUserId String? @unique`<br>• `memberExpiresAt DateTime?`<br>在 `@@index` 中可增加 `@@index([afdianUserId])` 便于按爱发电 user_id 查询。 |

### 1.2 迁移与已处理订单幂等（可选）

| 序号 | 文件 | 任务 |
|------|------|------|
| 1.2 | 新建迁移 | 执行 `npx prisma migrate dev --name add_afdian_member_fields`，生成迁移文件。 |
| 1.3 | （可选）幂等表 | 若希望 Webhook 严格幂等，可新建模型 `AfdianOrderProcessed { outTradeNo String @id; processedAt DateTime @default(now()) }` 并在 Webhook 中先查再写。 |

---

## 阶段 2：环境变量与配置

| 序号 | 文件 | 任务 |
|------|------|------|
| 2.1 | `.env.example` | 增加说明项：<br>• `AFDIAN_USER_ID=`（创作者 user_id）<br>• `AFDIAN_API_TOKEN=`（API 签名用，勿提交）<br>• `AFDIAN_OAUTH_CLIENT_ID=`<br>• `AFDIAN_OAUTH_CLIENT_SECRET=`<br>• `AFDIAN_OAUTH_REDIRECT_URI=`（如 `https://你的域名/api/afdian/oauth/callback`） |
| 2.2 | `.env`（本地/服务器） | 按爱发电后台实际值填写上述变量；生产环境 Webhook URL 需为 HTTPS。 |

---

## 阶段 3：爱发电 API 与签名（后端工具）

| 序号 | 文件 | 任务 |
|------|------|------|
| 3.1 | `lib/afdian.ts`（新建） | 实现：<br>• 签名函数：`sign(params: string, ts: number): string`，规则 `md5(api_token + params + ts + user_id)`，key 按字母序拼接。<br>• 请求封装：`requestApi(endpoint: string, params: object): Promise<unknown>`，POST 到 `https://afdian.net/api/open/{endpoint}`，body 含 user_id、params（JSON 字符串）、ts、sign。<br>• （可选）`querySponsors(page: number)` 调用「查赞助者」API，用于定时同步。 |

---

## 阶段 4：鉴权与会员过期逻辑

| 序号 | 文件 | 任务 |
|------|------|------|
| 4.1 | `lib/auth.ts` | 在 `requireMember()` 内：<br>• 若已存在 `memberExpiresAt`，且 `memberExpiresAt < new Date()`：可选地先执行一次「将 role 置为 normal、清空 memberExpiresAt」的更新（或交给定时任务），再 throw Forbidden。<br>• 保持现有 `role === 'member'` 判断；返回对象可增加 `memberExpiresAt` 供前端展示。 |
| 4.2 | `app/api/auth/me/route.ts` | 在 `select` 中增加 `memberExpiresAt: true`、`afdianUserId: true`（若需前端显示是否已绑定）；返回给前端的 `user` 对象中带上 `memberExpiresAt`、`afdianUserId`（可为 null）。 |

---

## 阶段 5：爱发电 OAuth2 绑定

| 序号 | 文件 | 任务 |
|------|------|------|
| 5.1 | `app/api/afdian/oauth/authorize/route.ts`（新建） | **GET**：生成 state（随机字符串，可存 session 或 cookie 防 CSRF），重定向到：<br>`https://afdian.net/oauth2/authorize?response_type=code&scope=basic&client_id={AFDIAN_OAUTH_CLIENT_ID}&redirect_uri={encodeURIComponent(AFDIAN_OAUTH_REDIRECT_URI)}&state={state}` |
| 5.2 | `app/api/afdian/oauth/callback/route.ts`（新建） | **GET**：接收 query 中 `code`、`state`。<br>• 校验 state 与发起时一致。<br>• 用 code 调爱发电 `https://afdian.net/api/oauth2/access_token`（POST，form：grant_type=authorization_code, client_id, client_secret, code, redirect_uri），得到 `user_id`（及 user_private_id）。<br>• 用 `requireAuth()` 取当前登录用户，将 `User.afdianUserId = data.user_id` 更新；若该 `user_id` 已被其他本站用户绑定，可拒绝并提示。<br>• 重定向回设置页或会员页，并带 success=1 等 query。 |
| 5.3 | `app/api/afdian/oauth/unbind/route.ts`（可选） | **POST**：需登录。将当前用户的 `afdianUserId` 置为 null（可选：同时将 role 改为 normal、清空 memberExpiresAt）。 |

---

## 阶段 6：爱发电 Webhook

| 序号 | 文件 | 任务 |
|------|------|------|
| 6.1 | `app/api/webhooks/afdian/route.ts`（新建） | **POST**：<br>• 不依赖 cookie/session；如需校验可查爱发电文档是否提供请求签名/密钥。<br>• 解析 JSON body，若 `data?.type !== 'order'` 或 `data?.order?.status !== 2`，直接返回 `{ ec: 200 }`（避免平台重试）。<br>• 幂等：若已处理过该 `out_trade_no`（查 AfdianOrderProcessed 或自建缓存），直接返回 `{ ec: 200 }`。<br>• 用 `data.order.user_id` 查 `User.afdianUserId`，找到则：<br>  - `role = 'member'`；<br>  - `memberExpiresAt = max(当前 memberExpiresAt, now) + order.month * 31 天`（或按爱发电规则 1 月=31 天）。<br>• 记录 `out_trade_no` 已处理（若建了幂等表）。<br>• 返回 `NextResponse.json({ ec: 200 })`。 |

---

## 阶段 7：会员过期与同步（可选）

| 序号 | 文件 | 任务 |
|------|------|------|
| 7.1 | 定时任务或 API | **方案 A**：新建 `app/api/cron/member-expire/route.ts`（或脚本 `scripts/member-expire.ts`），在服务器 cron 中定期调用：将 `memberExpiresAt < now()` 且 `role === 'member'` 的用户更新为 `role = 'normal'`、`memberExpiresAt = null`。<br>**方案 B**：仅在 `requireMember()` 中读到已过期时当场更新并拒绝，不单独跑 cron。 |
| 7.2 | 定时同步赞助者（可选） | 脚本或 cron 调用 `lib/afdian.ts` 的「查赞助者」API，遍历赞助者列表，用 `user_id` 匹配本站 `User.afdianUserId`，更新仍为赞助中的用户的 `role` 与 `memberExpiresAt`（需按爱发电文档解析 current_plan、expire 等）。 |

---

## 阶段 8：前端 - 设置页与绑定入口

| 序号 | 文件 | 任务 |
|------|------|------|
| 8.1 | `app/settings/page.tsx` | • 从 `/api/auth/me` 获取并展示 `memberExpiresAt`、`afdianUserId`。<br>• 已绑定：显示「已绑定爱发电」及到期日；提供「解绑」按钮调 `POST /api/afdian/oauth/unbind`（若有）。<br>• 未绑定：显示「绑定爱发电」按钮，点击跳转 `getApiUrl('/api/afdian/oauth/authorize')`。 |
| 8.2 | `app/api/user/profile/route.ts` | 若前端需要从 profile 拿会员信息，可在 GET 的 select 中增加 `role`、`memberExpiresAt`、`afdianUserId`（与 auth/me 保持一致即可，避免重复可只保留 auth/me）。 |

---

## 阶段 9：会员专属功能占位（示例）

| 序号 | 文件 | 任务 |
|------|------|------|
| 9.1 | 会员专属 API 示例 | 新建任意需会员的接口，如 `app/api/member/status/route.ts`：内部调用 `requireMember()`，返回 `{ ok: true, memberExpiresAt }`。用于验证整条链路。 |
| 9.2 | 会员专属页面占位 | 新建 `app/member/page.tsx`（或 under layout）：服务端或客户端用 `/api/auth/me` 判断 `role === 'member'`，非会员则重定向到设置页或付费说明页；会员则展示「会员中心」或后续角色升级、法术库等入口。 |

---

## 阶段 10：部署与配置

| 序号 | 任务 | 说明 |
|------|------|------|
| 10.1 | 爱发电 Webhook URL | 在爱发电开发者后台将 Webhook 地址设为 `https://你的域名/api/webhooks/afdian`。 |
| 10.2 | OAuth redirect_uri | 与爱发电后台配置的 redirect_uri 完全一致（含协议、域名、路径）。 |
| 10.3 | 环境变量 | 服务器 `.env` 中配置所有 `AFDIAN_*` 变量；确保 `AFDIAN_API_TOKEN` 等不进入前端。 |
| 10.4 | Cron（若用） | 若采用阶段 7 的定时任务，在服务器配置 cron 调用 `GET /api/cron/member-expire`（建议加 secret query 或 header 鉴权，避免被随意调用）。 |

---

## 检查清单（按顺序自检）

- [ ] 阶段 0：分支与 tag 已创建
- [ ] 阶段 1：Schema 已改、迁移已执行
- [ ] 阶段 2：.env.example 与本地/服务器 .env 已配置
- [ ] 阶段 3：`lib/afdian.ts` 签名与请求可用（可用爱发电 ping 接口自测）
- [ ] 阶段 4：`requireMember()` 与 `/api/auth/me` 已支持到期与绑定信息
- [ ] 阶段 5：OAuth 发起与回调可完成绑定
- [ ] 阶段 6：Webhook 可接收并正确更新用户角色与到期时间，且幂等
- [ ] 阶段 7：（可选）过期与赞助者同步已实现
- [ ] 阶段 8：设置页可绑定/解绑并展示会员状态
- [ ] 阶段 9：至少一个会员接口与一个会员页可走通
- [ ] 阶段 10：生产 Webhook、OAuth、cron 已配置

---

## 文件与 API 一览（会员分支新增/修改）

| 类型 | 路径 |
|------|------|
| 修改 | `prisma/schema.prisma` |
| 修改 | `.env.example` |
| 修改 | `lib/auth.ts` |
| 修改 | `app/api/auth/me/route.ts` |
| 修改 | `app/settings/page.tsx` |
| 新建 | `lib/afdian.ts` |
| 新建 | `app/api/afdian/oauth/authorize/route.ts` |
| 新建 | `app/api/afdian/oauth/callback/route.ts` |
| 新建 | `app/api/afdian/oauth/unbind/route.ts`（可选） |
| 新建 | `app/api/webhooks/afdian/route.ts` |
| 新建 | `app/api/cron/member-expire/route.ts` 或脚本（可选） |
| 新建 | `app/api/member/status/route.ts`（示例） |
| 新建 | `app/member/page.tsx`（示例） |
| 可选 | 幂等表迁移、`app/api/user/profile` 扩展 |

完成以上步骤后，会员分支即可实现「绑定爱发电 → Webhook 开通/续期 → 会员专属功能」的完整闭环；后续只需在会员分支上继续增加角色升级、法术库、装备等业务功能，并在对应路由使用 `requireMember()` 即可。
