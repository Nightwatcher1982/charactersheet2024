# 整体功能测试结果

测试时间：2026-02-02  
环境：本地开发服务器（Next.js dev，端口 3001）

---

## 1. 构建与修复

- **问题**：`npm run build` 报错 `adminSessionOptions` 未从 `@/lib/admin-session` 导出。
- **修复**：在 `lib/admin-session.ts` 中为 `adminSessionOptions` 增加 `export`。
- **结果**：`npm run build` 通过，类型检查与静态生成正常。

---

## 2. 前端页面可访问性（HTTP 状态）

| 路径 | 状态 | 说明 |
|------|------|------|
| `/` | 200 | 首页正常 |
| `/login` | 308 | 重定向（Next  trailing slash 等），页面可访问 |
| `/admin/login` | 308 | 同上 |

---

## 3. 用户端 API 测试

### 3.1 未登录态

| 接口 | 方法 | 预期 | 结果 |
|------|------|------|------|
| `/api/auth/me/` | GET | 未登录返回 isLoggedIn:false | ✅ `{"isLoggedIn":false}`，HTTP 401 |
| `/api/auth/send-code/` | POST body `{}` | 400，提示邮箱 | ✅ `{"error":"请输入正确的邮箱地址"}` |
| `/api/auth/send-code/` | POST body `{email, type:"register"}` | 成功并返回验证码（开发模式） | ✅ `success:true`，返回 `code` |

### 3.2 注册与登录

| 步骤 | 操作 | 结果 |
|------|------|------|
| 1 | POST send-code（email + type=register） | ✅ 返回 6 位验证码（开发环境） |
| 2 | POST register（email + password + code + agreementVersion） | ✅ `{"success":true,"message":"注册成功","user":{...}}` |
| 3 | POST login（email + password） | ✅ `{"success":true,"message":"登录成功","user":{...}}` |

说明：验证码需在发送后尽快使用；间隔过久或重复使用会报「验证码错误或已过期」。

### 3.3 已登录态

| 接口 | 方法 | 结果 |
|------|------|------|
| `/api/auth/me/` | GET（带登录 cookie） | ✅ `isLoggedIn:true`，含 user（id、email、displayName、role） |
| `/api/user/profile/` | GET | ✅ 返回用户资料（email、displayName、contactInfo、role、emailVerifiedAt 等） |
| `/api/characters/` | GET | ✅ 返回 `{success:true, characters:[]}`（新用户为空列表） |
| `/api/user/login-history/` | GET | ✅ 返回 `logs` 数组，含最近登录记录（ip、userAgent、createdAt） |

### 3.4 登出

| 接口 | 结果 |
|------|------|
| POST `/api/auth/logout/`（带 cookie） | ✅ `{"success":true,"message":"已退出登录"}` |
| GET `/api/auth/me/`（登出后） | ✅ `{"isLoggedIn":false}` |

---

## 4. 后台 API 测试

| 接口 | 条件 | 预期 | 结果 |
|------|------|------|------|
| `/api/admin/me/` | 未登录后台 | 401 | ✅ 需带 admin session，否则为未登录/重定向 |
| `/api/admin/stats/` | 未登录后台 | 401 | ✅ `{"error":"请先登录后台"}` |
| `/api/admin/login/` | POST 错误邮箱/密码 | 401 | ✅ `{"error":"邮箱或密码错误"}` |

**说明**：完整后台流程（登录 → 用户列表、用户详情、重置密码、改等级、审计日志）需先在本地执行 `ADMIN_EMAIL=xxx ADMIN_PASSWORD=xxx npm run create-admin`（或 `npx tsx scripts/create-admin.ts`）创建管理员账号后，再在浏览器或 curl 中带 admin cookie 访问上述接口。

---

## 5. 小结

- **构建**：已修复 `adminSessionOptions` 导出，当前 `npm run build` 通过。
- **用户流程**：注册（邮箱+验证码）→ 登录 → 个人资料、角色卡列表、登录历史 → 登出，接口行为符合设计。
- **后台**：未登录时正确返回 401/错误信息；完整后台功能依赖已创建的管理员账号。

建议在本地或 CI 中增加：
1. 创建测试用管理员（如通过 seed 或脚本）；
2. 对 `/api/admin/login/` 登录后请求 `/api/admin/stats/`、`/api/admin/users/` 等做自动化断言。
