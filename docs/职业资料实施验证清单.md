# 职业资料与升级功能实施验证清单

本文档供**子 agent 或人工**对照 `职业资料改动清单-12职业.md` 与 `职业资料与升级功能完善计划.md` 验证本次开发的代码是否符合改动需求逻辑。

---

## 一、已实现项（请逐项验证）

### 1. 数据层

| 项目 | 文件/位置 | 验证要点 |
|------|------------|----------|
| 法术名→id 映射 | `lib/spells-data.ts` 中 `getSpellIdByName(nameOrId)` | 支持中文名、英文名、id 解析为 spell id |
| 子职业法术表 | `lib/subclass-spells-data.ts` | 德鲁伊(大地 4 地形/月亮/海洋/星辰)、牧师 4 领域、圣武士 4 誓约、术士 3 子职(畸变/时械/龙族)、游侠(妖精漫游者/幽域追猎者)、魔契师 4 宗主；`getSubclassSpellIdsUpToLevel()`、`getDruidLandSpellsByLevel(terrain)` |
| 法师学派入书 | `lib/wizard-school-spells.ts` | 防护/预言/塑能/幻术：3 级 2 道≤二环 + 每新环阶 1 道；`getWizardSchoolSpellIdsForLevel(schoolId, characterLevel)` |

### 2. 升级流程（`app/characters/[id]/level-up/page.tsx`）

| 需求 | 实现方式 | 验证要点 |
|------|----------|----------|
| 生命值只更新上限 | 仅写 `hitPoints`，不写 `currentHitPoints` | 确认 `updates` 中无 `currentHitPoints` |
| 大地结社 3 级选地形 | Step 2 选「大地结社」后显示地形单选（荒漠/极地/温带/热带），存 `classFeatureChoices.landTerrain` | 选 Land 后是否必须选地形才能下一步；完成升级后 choices 含 `landTerrain` |
| 子职法术自动追加 | `handleFinish` 中根据 classId/subclassId/newLevel（及 landTerrain）调 `getSubclassSpellIdsUpToLevel`，合并入 `updates.spells` | 升级后角色 `spells` 是否包含对应子职法术 id |
| 法师学派法术入书 | 法师且已选学派时，调 `getWizardSchoolSpellIdsForLevel(subclassId, newLevel)` 合并入 `updates.spells` | 法师 3 级选学派、5/7/9… 级升级后法术书中是否含学派法术 |
| 法师 2 级学者 | Step 3 显示「学者：选择 1 项已熟练技能获得专精」，选项为 奥秘/历史/调查/医药/自然/宗教 与 `character.skills` 交集；存 `classFeatureChoices.scholarSkill` 并追加到 `expertiseSkills` | 法师 2 级升级时是否有学者步骤；保存后 expertiseSkills 与 scholarSkill 是否正确 |
| 魔契师 11/13/15/17 级玄奥秘法 | Step 3 显示「玄奥秘法：选择 1 道 6/7/8/9 环法术」下拉，存 `updates.mysticArcanum.level6/7/8/9` | 魔契师对应等级升级时是否出现玄奥秘法选择；完成后续约是否写入 `mysticArcanum` |

### 3. 逻辑一致性

- **子职业法术**：德鲁伊大地结社必须选地形后才可完成 Step 2（`canProceedFromStep2` 含 `isDruidLand && !landTerrain`）。
- **合并去重**：子职法术与学派法术合并到 `spells` 时使用 `[...new Set([...existing, ...spellIdsToAdd])]`，无重复。
- **等级与档位**：`getSubclassSpellIdsUpToLevel` 仅返回 `level <= characterLevel` 的档位，升级到 5 级会包含 3 与 5 级档位法术。

---

## 二、本次继续实施后新增（验证通过后可勾选）

- 圣武士/游侠 2 级**战斗风格**：Step 3 选择（防御 / 受祝福的勇士 或 德鲁伊教战士），存 `classFeatureChoices.fightingStyle`
- 野蛮人 3 级**原初学识**：Step 3 选 1 项野蛮人技能获熟练，存 `primalKnowledgeSkill`，并追加到 `character.skills`
- 牧师 7 级**受祝击**：神圣打击 / 强力施法，存 `classFeatureChoices.blessedStrikes`
- 德鲁伊 7 级**元素之怒**：强力施法 / 原力蛮击，存 `classFeatureChoices.elementalFury`
- 术士龙族 6 级**元素亲和**：强酸/寒冷/火焰/闪电/毒素，存 `classFeatureChoices.draconicElement`
- 驯兽师 3 级**原初行侣**：大地/海洋/天空野兽，存 `classFeatureChoices.primalCompanionType`
- 猎人 3 级**猎杀技艺**：巨像屠夫/灭族者，存 `classFeatureChoices.hunterPrey`
- 猎人 7 级**防守战术**：冲出重围/多重防御，存 `classFeatureChoices.hunterDefense`

## 三、本轮已实现（请子 Agent 在验证任务中重点核对）

- 法师 18 级**法术精通**：从法术书选 1 道一环 + 1 道二环，存 `classFeatureChoices.spellMastery`
- 法师 20 级**招牌法术**：从法术书选 2 道三环，存 `classFeatureChoices.signatureSpells`
- 游侠 2 级**熟练探险家**：选 1 项已熟练技能获专精 + 选 2 门语言，存 `deftExplorerSkill` / `deftExplorerLanguages`，合并进 `expertiseSkills` 与 `languages`
- 逸闻学院 3 级：选 3 项技能熟练，存 `loreExtraSkills`，合并进 `character.skills`
- 逸闻学院 6 级**魔法探秘**：选 2 道法术（牧师/德鲁伊/法师），存 `loreMagicalSecrets`，合并进 `spells`
- 术士 2/10/17 级**超魔法**：数量按 `getMetamagicCountAtLevel`，存 `classFeatureChoices.metamagic`（数据见 `lib/metamagic-data.ts`）
- 魔契师每级**魔能祈唤**：数量按 `INVOCATION_COUNT_BY_LEVEL`，先决用 `getAvailableInvocations`，存 `classFeatureChoices.invocations`（数据见 `lib/invocation-data.ts`）
- 战斗大师 3/7/10/15 级**战技**：数量按 `getManeuverCountAtLevel`，存 `classFeatureChoices.maneuvers`（数据见 `lib/maneuvers-data.ts`）
- 施法者升级**选新法术**：按 `getSpellcastingRules` 与当前法术数差值在 Step 3 选 N 道，合并进 `character.spells`

## 四、创建流程 1 级选择（已实现）

- **牧师 1 级圣职**：创建时在「选择职业」步骤中，技能选择后会弹出 `ClassFeatureSelectorModal` 选择守护者/奇术师，存 `classFeatureChoices.divineOrder`；奇术师在 `getSpellcastingRules` 中 +1 戏法已生效。
- **德鲁伊 1 级原初职能**：同上，选择术师/卫士，存 `classFeatureChoices.primalOrder`；术师在 `getSpellcastingRules` 中 +1 戏法已生效。
- 步骤 1 完成条件已包含：若职业有 `featureChoices`，须全部已选方可视为完成。

## 五、本轮补充实现（顺序完成）

- **游侠 9 级专精**：`class-level-table` 已含游侠 9 级 `expertise`，升级 Step 3 专精步骤自动生效。
- **吟游诗人 10 级魔法奥秘**：升级到 10 级时从诗人/牧师/德鲁伊/法师法术表（≤5 环）选 1 道，存 `classFeatureChoices.magicalSecrets10`，合并进 `spells`；诗人 10 级「选新法术」计数已减 1 避免重复。
- **妖精漫游者 3 级**：选 欺瞒/表演/游说 之一熟练，存 `classFeatureChoices.feyWandererSkill`，合并进 `character.skills`。
- **德鲁伊 2 级荒野变形·已知形态**：选 4 种野兽形态（CR≤1/4 无飞行），存 `classFeatureChoices.wildShapeForms`（JSON 数组）。
- **兽心道途 3/6/14 级**：3 级兽性狂暴选 熊/鹰/狼（`beastRageForm`），6 级兽之形貌选 枭/豹/鲑（`beastFormAspect`），14 级兽力威能选 猎鹰/雄狮/角羊（`beastPowerAspect`）。
- **诗人 20 级创生圣言**：升级到 20 级时自动将律令医疗、律令死亡加入 `spells`。
- **幻术师 3 级次级幻象**：法师选幻术师且升级到 3 级时，若法术列表中尚无次级幻象戏法，自动加入 `minor-illusion`。

## 六、仍未实现项（后续迭代）

- 战士 1 级战斗风格、术士 1 级术士起源、魔契师 1 级契约恩赐等已在 `dnd-data` 的 `featureChoices` 中配置，创建流程会同样弹出选择（无需额外开发）。

---

## 七、建议验证步骤（子 agent / 人工）

1. **构建**：在项目根目录执行 `npm run build`，确认无报错。
2. **数据层**：在 `lib/subclass-spells-data.ts` 中任选一子职，核对 `spellsByLevel` 与 DND 资料文档中法术表一致（名称可对照 `getSpellIdByName` 或 spells-data）。
3. **升级流程**：创建或选用 2 级德鲁伊，升级到 3 级，选择大地结社 → 选择地形 → 完成升级；检查角色 `spells` 与 `classFeatureChoices.landTerrain`。
4. **法师**：2 级法师升级选学者技能；3 级选学派后检查法术书是否含 2 道学派法术。
5. **魔契师**：10 级魔契师升级到 11 级，Step 3 是否出现玄奥秘法 6 环选择，保存后 `mysticArcanum.level6` 是否有值。
6. **生命值**：任意职业升级后，确认 `currentHitPoints` 未被修改（仅 `hitPoints` 增加）。

---

## 八、结论模板（验证完成后填写）

- [ ] 数据层与清单一致
- [ ] 升级流程与清单已实现项一致
- [ ] 生命值仅更新上限
- [ ] 未实现项已记录，无遗漏

验证人/Agent：__________ 日期：__________
