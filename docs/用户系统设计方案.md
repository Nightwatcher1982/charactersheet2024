# 用户系统设计方案

本文档描述在现有 D&D 2024 角色卡项目上增加完整用户系统的需求、设计与实现要点，并补充常见用户管理模块功能提醒。

---

## 一、需求与对应设计

### 1. 邮箱 + 密码注册与登录

- **需求**：用户通过邮箱和密码进行注册和登录。
- **设计**：
  - 注册：`POST /api/auth/register`，入参 `email`、`password`（及可选邮箱验证码）。
  - 登录：`POST /api/auth/login`，入参 `email`、`password`。
  - 密码使用 **bcrypt** 存储（项目已依赖），强度建议 10–12。
  - 邮箱作为业务主键：唯一、不可重复注册；登录态与用户数据均以邮箱关联。

### 2. 用户数据以邮箱为主键

- **需求**：用户相关数据以邮箱为主键、唯一标识管理。
- **设计**：
  - `User` 表设 `email` 字段，`@unique`，并建立唯一索引。
  - 现有 `User` 表以 `phone` 为主：需**数据迁移**，增加 `email` 并逐步改为以 `email` 为主键；旧 `phone` 可保留为可选绑定字段或迁移后废弃（见迁移小节）。

### 3. 用户基本信息

- **需求**：用户可填写名称、联系方式等基本信息。
- **设计**：
  - `User` 表增加字段：`displayName`、`contactInfo`（或拆成 `phone`、`wechat` 等），均为可选。
  - 前端：个人中心/设置页，表单编辑上述字段；接口 `GET/PUT /api/user/profile`。

### 4. 查看自己创建的角色卡

- **需求**：用户只能查看自己创建的角色卡。
- **设计**：
  - 角色卡已在库中通过 `Character.userId` 关联用户，现有 `GET /api/characters`、`GET /api/characters/[id]` 已按 session 的 `userId` 过滤，保持即可。
  - 前端「我的角色」列表仅请求 `/api/characters`，详情页仅允许访问 `userId` 匹配的角色。

### 5. 角色卡持久化

- **需求**：角色卡信息持久化保存在数据库中。
- **设计**：
  - 已实现：`Character` 表存 `userId`、`data`（JSON）。创建/编辑/删除走 `/api/characters` 与 `/api/characters/[id]`。
  - 需保证：创建/编辑角色卡时用户已登录，且服务端始终用 session 中的 `userId` 写入，不信任前端传入的 userId。

### 6. 角色立绘上传到 OSS

- **需求**：创建角色卡时可上传立绘，图片存 OSS。
- **设计**：
  - 当前立绘为 base64 存于角色 JSON 内；改为「上传得 URL，角色只存 URL」。
  - **方式 A（推荐）**：服务端生成 OSS 临时上传凭证（STS 或 PostPolicy），前端直传 OSS，上传成功后拿 OSS 返回的 URL 写入角色 `avatar` / `portraits`。
  - **方式 B**：前端把文件 POST 到 Next.js API，由 API 用 SDK 上传 OSS，再返回 URL。
  - 存储路径建议：`charactersheet2024/user-uploads/{userId}/{characterId}/{filename}`，便于按用户/角色管理。
  - 角色 JSON 中 `avatar`、`portraits` 存字符串或字符串数组（URL），兼容现有 `getAssetPath` 逻辑；若 URL 已是完整 OSS 地址，可直接用。

### 7. 用户等级（普通 / 会员）

- **需求**：至少分为普通用户与会员用户，后续会员享有额外功能。
- **设计**：
  - `User` 表增加 `role` 或 `tier` 字段，例如：`normal` | `member`（可扩展 `admin` 等）。
  - 接口与前端在需要「仅会员」的功能处校验 `user.role === 'member'`；后台可改用户等级。

### 8. 邮箱验证码（注册 / 改密 / 换邮箱）

- **需求**：注册须邮箱验证码；修改密码、更换邮箱须原邮箱验证码；需确认阿里云对个人用户是否支持。
- **结论（阿里云）**：
  - **邮件推送（Direct Mail）**：个人实名认证后可开通，可用于发送触发类邮件（如注册验证、找回密码）。适合「邮箱验证码」。
  - **短信**：项目已接阿里云短信，若要做「手机验证码」可沿用现有 `lib/sms.ts`。
- **设计**（已按「注册/改密/换邮箱均用邮箱验证码」落实）：
  - **注册**：必须「邮箱验证码」校验后再写库；用户输入邮箱 → 发验证码到该邮箱 → 用户提交邮箱+密码+验证码 → 校验通过后创建账号。
  - **登录**：仅邮箱+密码，无需验证码。
  - **修改密码**：向**当前账号绑定邮箱**发验证码，用户提交验证码+新密码后更新密码。
  - **更换邮箱**：先向**当前邮箱**发验证码确认身份，再向**新邮箱**发验证码确认归属；两轮验证通过后更新邮箱。
  - **忘记密码**：用户输入邮箱 → 若账号存在则向该邮箱发验证码 → 用户提交邮箱+验证码+新密码后重置（无需旧密码）。
  - 验证码存 `VerificationCode` 表，增加 `email`、`type`（如 `register` / `change_password` / `change_email` / `reset_password`）；邮件发送使用阿里云 Direct Mail 的 SingleSendMail 或 Node SDK，环境变量如 `ALIYUN_DM_*`。

### 9. 登录态保持约 15 天

- **需求**：用户可保持登录状态约 15 天再重新登录。
- **设计**：
  - 当前 session 使用 `iron-session`，`cookieOptions.maxAge` 为 7 天；改为 `60 * 60 * 24 * 15`（15 天）。
  - 若希望「记住我」可选更长：可增加「记住我」勾选，勾选时 maxAge 设为 30 天，否则 15 天或 7 天。

### 10. 后台管理

- **需求**：后台可管理用户、重置密码、改会员等级、查看会员角色卡等；后台需管理员密码才能进入。
- **设计**：
  - **路由**：如 `/admin`，下分子页：用户列表、用户详情（含角色卡列表）、重置密码、修改等级等。
  - **鉴权**：单独「管理员登录」：例如 `POST /api/admin/login`，校验管理员账号密码（或与普通用户表隔离的 Admin 表），通过后写 admin session（如 `adminSession` cookie 或 session 里 `isAdmin: true`）。所有 `/admin` 及 `/api/admin/*` 中间件校验该 session。
  - **功能**：用户列表（分页、按邮箱/名称/等级筛选）、用户详情、重置密码（发重置链接或直接设新密码）、修改用户等级、查看该用户下角色卡列表及详情（只读或只允许管理员操作）。

### 11. 后台管理员密码登录

- **需求**：后台仅能通过管理员密码（登录）进入。
- **设计**：
  - 管理员账号不暴露在注册流程；可在 DB 中建 `Admin` 表（id、email/username、passwordHash）或在一个配置/环境变量中存「第一个管理员」的邮箱+密码哈希，首次部署时写入。
  - 后台登录页仅接受「管理员账号+密码」，校验通过后下发 admin session；不提供普通用户登录入口。

### 12. 其他常见用户模块功能（防遗漏）

建议在设计与迭代中考虑以下功能，按需实现：

| 功能 | 说明 |
|------|------|
| **忘记密码** | 通过邮箱发重置链接或验证码，设置新密码；需邮件发送能力。 |
| **修改密码** | 登录后「安全设置」中，输入旧密码+新密码。 |
| **修改邮箱** | 需验证新邮箱（验证码）且旧邮箱确认或密码确认，避免账号被篡夺。 |
| **账号注销** | 用户申请注销，软删除或标记状态，一段时间后物理删除或匿名化；角色卡可一并删除或转移策略。 |
| **登录历史 / 安全日志** | 记录登录时间、IP、设备等，便于用户发现异常；可选。 |
| **多端登出** | 「登出所有设备」：使该用户已有 session 失效（如清空服务端 session 表或使 token 版本递增）。 |
| **注册/登录限流** | 按 IP 或邮箱限制验证码、登录尝试频率，防暴力与滥用。 |
| **邮箱验证状态** | 注册时是否已验证邮箱，用于后续「仅已验证用户可发帖/创建角色」等策略。 |
| **用户协议与隐私政策** | 注册时勾选同意，并保留同意记录与版本号。 |
| **敏感操作二次验证** | 如修改邮箱、注销账号时要求再次输入密码或验证码。 |
| **后台操作审计** | 管理员操作（重置密码、改等级等）写日志或审计表，便于追溯。 |

---

## 二、数据模型变更摘要

- **User**  
  - 主键仍为 `id`；业务主键为 `email`（唯一）。  
  - 新增：`email`（必填、唯一）、`passwordHash`、`displayName`、`contactInfo`、`role`（如 `normal` | `member`）；`phone` 改为可选或废弃（见迁移）。  
  - 保留：`createdAt`、`updatedAt`。

- **Session**  
  - 现有会话表若用于「多端登出」可保留；当前登录态以 iron-session cookie 为主也可。

- **Character**  
  - 已满足；仅需保证 `userId` 正确、立绘字段存 OSS URL。

- **VerificationCode**  
  - 增加 `email`、`type`（`email` | `phone`）或拆表，支持邮箱验证码。

- **Admin**（可选）  
  - 表：id、username/email、passwordHash、createdAt；或使用环境变量 + 单条配置。

---

## 三、迁移与兼容

1. **现有用户（仅 phone）**  
   - 若保留老用户：为 `User` 增加 `email`、`passwordHash` 等，先设为可空；为老用户生成随机不可登录邮箱（如 `legacy-{id}@internal`）或要求老用户「绑定邮箱并设密」一次后再用新登录方式。  
   - 若可清空用户：直接改为 email 唯一，旧表可备份后重建。

2. **角色卡**  
   - 已按 `userId` 关联，用户主键从 phone 改为 id 不变，无需动 Character 表结构；仅需确保新登录态中 `userId` 与现有一致（若同一批用户迁移）。

3. **立绘**  
   - 旧数据为 base64 可保留兼容（前端判断 URL 还是 data URL）；新上传一律走 OSS 存 URL。

---

## 四、阿里云邮件推送（邮箱验证码）简要

- **开通**：阿里云控制台 → 邮件推送（Direct Mail），个人实名认证后可开通；按量或资源包均可。
- **发信**：使用 SingleSendMail 或 Node SDK（如 `@alicloud/dm20151123`），配置发信域名、发信地址、AccessKey。
- **验证码**：自建 HTML/文本模板，替换 `{{code}}`；验证码存库、校验过期与尝试次数（与现有短信验证码逻辑类似）。

---

## 五、实现顺序建议

1. **数据与鉴权**：Prisma 中 User 增加 email、passwordHash、displayName、contactInfo、role；VerificationCode 支持 email；session 改为存 email，maxAge 15 天。  
2. **注册/登录**：注册（含密码哈希）、登录（校验密码）、登出；可选邮箱验证码（依赖 Direct Mail 开通后再接）。  
3. **个人资料**：GET/PUT profile。  
4. **角色卡与权限**：确认现有 API 仅操作当前用户的角色；立绘上传 OSS + 角色存 URL。  
5. **会员逻辑**：接口与前端按 `user.role` 做会员功能开关。  
6. **后台**：Admin 登录、用户列表/详情、重置密码、改等级、查看用户角色卡；操作审计可选。  
7. **补充**：忘记密码、修改密码、限流、协议勾选等按需排期。

---

以上方案覆盖你列出的 1–12 条需求，并补充了常见用户管理功能清单与实现顺序，可直接作为开发与评审依据。

**开发计划**：分阶段实施、验收标准与接口速查见 [用户系统开发计划方案.md](./用户系统开发计划方案.md)。该计划约定：注册须邮箱验证码；修改密码、更换邮箱、忘记密码均通过原邮箱（或目标邮箱）验证码完成。
