# 爱发电接入预留说明

当前会员分支已预留对接爱发电的基础，**未实现**实际 OAuth、Webhook 与 API 调用。等会员专属内容有一定规模后，按本文与《会员分支改造任务清单》接入即可。

---

## 已完成的预留

| 项 | 说明 |
|----|------|
| **User 表** | 已增加 `afdianUserId`（唯一）、`memberExpiresAt`；迁移见 `prisma/migrations/20260208000000_add_afdian_member_fields`。 |
| **环境变量** | `.env.example` 已增加 `AFDIAN_USER_ID`、`AFDIAN_API_TOKEN`、`AFDIAN_OAUTH_*` 占位与说明。 |
| **/api/auth/me** | 已返回 `afdianUserId`、`memberExpiresAt`，前端后续可直接用于「绑定状态」「会员到期」展示。 |
| **requireMember()** | 已按 `memberExpiresAt` 做到期校验：若已过期则视为非会员（与爱发电 1 月≈31 天一致）。 |

---

## 接入时需补做的工作（清单摘要）

1. **爱发电后台**：在 [开发者后台](https://afdian.net/dashboard/dev) 申请 OAuth2（client_id、client_secret、redirect_uri）、获取 user_id 与 api_token，配置 Webhook URL。
2. **后端**：新建 `lib/afdian.ts`（签名与 API 请求）、OAuth 路由（authorize / callback / unbind）、`POST /api/webhooks/afdian`，可选定时过期与赞助者同步。
3. **前端**：在设置页增加「绑定爱发电」入口与会员到期展示；会员中心等页面已可用 `requireMember()` 保护。
4. **部署**：在服务器 `.env` 配置上述变量，并在爱发电后台填写生产 Webhook 与 redirect_uri。

详细步骤与文件列表见 **《会员分支改造任务清单》** 阶段 3～10。

---

## 本地应用迁移

首次拉取本分支或在新环境部署时，执行：

```bash
npx prisma migrate deploy
```

开发环境若需重置迁移历史，可使用：

```bash
npx prisma migrate dev
```
