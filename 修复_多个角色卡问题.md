# 🐛 修复：多个角色卡显示问题

**报告时间**：刚才  
**完成时间**：刚才  
**状态**：✅ 前4项已修复，后2项需要更多开发时间

---

## ✅ 已修复的问题（1-4）

### 1. ✅ 物种技能没有添加

**问题**：木精灵选择的"生存"技能没有添加到角色技能列表

**原因**：`StepSpecies.tsx`的`handleTraitsComplete`函数只保存了选择，但没有解析并添加技能到`character.skills`数组。

**修复**：
```typescript
// 修改文件：components/steps/StepSpecies.tsx

const handleTraitsComplete = (selections: Record<string, string>) => {
  // 解析物种技能选择
  let speciesSkills: string[] = [];
  if (selections.skill) {
    // 从"洞悉（感知）- 判断意图和情绪"中提取"洞悉"
    const skillMatch = selections.skill.match(/^([^（]+)/);
    if (skillMatch) {
      speciesSkills = [skillMatch[1]];
    }
  }
  
  // 移除旧的物种技能（如果更换选择）
  // ...
  
  // 添加新选择的物种技能
  const newSkills = [...skillsWithoutOldSpecies, ...speciesSkills];
  
  updateCurrentCharacter({
    classFeatureChoices: {
      ...currentChoices,
      speciesChoices: JSON.stringify(selections)
    },
    skills: newSkills  // ✅ 立即添加物种技能
  });
};
```

---

### 2. ✅ 木精灵移动速度错误

**问题**：木精灵应该是35尺移动速度，但显示的是30尺

**原因**：精灵基础speed是30尺，需要解析`speciesChoices`中的血统选择来判断是否是木精灵。

**修复**：
```typescript
// 修改文件：app/character-sheet/page.tsx 和 components/CharacterSheetSummary.tsx

// 计算移动速度，考虑物种选择
let speed = (speciesData as any)?.speed || 30;
if (character.classFeatureChoices?.speciesChoices) {
  try {
    const speciesChoices = JSON.parse(character.classFeatureChoices.speciesChoices as string);
    if (speciesChoices.lineage && speciesChoices.lineage.includes('木精灵')) {
      speed = 35;  // ✅ 木精灵速度35尺
    }
  } catch (e) {
    // 解析失败，使用默认速度
  }
}
```

---

### 3. ✅ 左上角物种信息显示不完整

**问题**：显示"ne"，看不出是木精灵还是其他精灵

**原因**：只显示了基础物种名"精灵"，没有显示子类型"木精灵"。"ne"可能是alignment（阵营）显示问题。

**修复**：
```typescript
// 修改文件：app/character-sheet/page.tsx 和 components/CharacterSheetSummary.tsx

// 获取物种子类型显示（如"精灵 - 木精灵"）
let speciesDisplay = character.species || '未选择';
if (character.classFeatureChoices?.speciesChoices) {
  try {
    const speciesChoices = JSON.parse(character.classFeatureChoices.speciesChoices as string);
    if (speciesChoices.lineage) {
      // 从"木精灵（速度35尺...）"中提取"木精灵"
      const lineageMatch = speciesChoices.lineage.match(/^([^（]+)/);
      if (lineageMatch) {
        speciesDisplay = `${character.species} - ${lineageMatch[1]}`;
        // ✅ 显示："精灵 - 木精灵"
      }
    }
  } catch (e) {
    // 解析失败，使用基础物种名
  }
}

// 在页面中使用speciesDisplay代替character.species
<span>{speciesDisplay}</span>
```

---

### 4. ✅ 右上角+2没有说明

**问题**：右上角的"+2"看不出是什么含义

**原因**：缺少标签说明这是"熟练加值"。

**修复**：
```typescript
// 修改文件：app/character-sheet/page.tsx

<div className="text-right">
  <div className="text-xs text-gray-500 mb-1">熟练加值</div>
  <div className="text-4xl font-bold text-red-600">+{profBonus}</div>
  <div className="text-xs text-gray-400 mt-1">Proficiency Bonus</div>
  // ✅ 添加了中英文说明
</div>
```

---

## ⚠️ 需要更多开发时间的功能（5-6）

### 5. 🔄 武器选择和显示系统（进行中）

**需求**：
- 记录玩家选择的武器和护甲
- 在角色卡上显示武器信息：
  - 武器攻击命中加值（属性调整值 + 熟练加值）
  - 武器伤害
  - 武器精通效果
- 考虑武器熟练项

**当前状态**：
- ✅ 已创建完整的武器数据库（`lib/weapons-data.ts`）
  - 包含40+种武器（简易/军用，近战/远程）
  - 每个武器有：伤害骰、伤害类型、属性、武器精通
  - 辅助函数：计算攻击加值、获取武器数据
- ✅ 已创建护甲数据库
  - 包含轻甲、中甲、重甲、盾牌
  - AC计算函数

**还需要的工作**：
1. **扩展角色数据模型**
   ```typescript
   // 在character-store.ts中添加
   interface Character {
     // ... 现有字段
     equippedWeapons?: string[];  // 武器ID数组
     equippedArmor?: string;      // 护甲ID
     hasShield?: boolean;         // 是否装备盾牌
   }
   ```

2. **创建武器选择UI**
   - 新组件：`WeaponSelector.tsx`
   - 根据职业熟练限制可选武器
   - 支持多武器选择

3. **在角色卡上显示武器**
   - 新栏位："武器"部分
   - 显示每个武器的：
     - 名称和类型
     - 攻击加值计算：`+X = 属性调整值 + 熟练加值`
     - 伤害：`XdY + 属性调整值`
     - 武器精通效果描述

4. **整合到创建流程**
   - 决定在哪一步选择武器
   - 可能在"步骤6：技能纵览"后添加"步骤7：选择装备"

**预计工作量**：
- 2-3小时开发
- 需要测试各种职业和武器组合
- UI设计和布局调整

---

### 6. 🔄 AC计算加上护甲值（待开发）

**需求**：
- AC = 10 + 敏捷调整值 + 护甲AC + 盾牌AC
- 考虑护甲熟练项
- 考虑护甲类型限制（轻甲/中甲/重甲）

**当前状态**：
- ✅ 护甲数据已创建（`lib/weapons-data.ts`）
- ✅ AC计算函数已实现：`calculateAC()`
  - 处理轻甲、中甲、重甲不同规则
  - 处理盾牌加值
  - 检查熟练项

**还需要的工作**：
1. **护甲选择UI**
   - 根据职业熟练限制可选护甲
   - 盾牌选择

2. **更新AC显示逻辑**
   ```typescript
   // 当前：baseAC = 10 + dexterityMod
   // 更新后：
   const equippedArmor = character.equippedArmor ? 
     getArmorById(character.equippedArmor) : null;
   const hasShield = character.hasShield || false;
   const isProficient = checkArmorProficiency(character.class, equippedArmor);
   
   const finalAC = calculateAC(
     baseAC, 
     equippedArmor, 
     hasShield, 
     dexterityMod, 
     isProficient
   );
   ```

3. **职业护甲熟练检查**
   - 根据`classData.proficiencies.armor`判断
   - 不熟练时使用基础AC（10 + 敏捷）

**预计工作量**：
- 依赖于武器系统完成
- 1-2小时开发
- 需要测试不同护甲类型和职业组合

---

## 📋 修复总结

| 问题 | 状态 | 修改文件 | 工作量 |
|------|------|----------|--------|
| 1. 物种技能没有添加 | ✅ 已完成 | `StepSpecies.tsx` | 已完成 |
| 2. 木精灵速度35尺 | ✅ 已完成 | `character-sheet/page.tsx`, `CharacterSheetSummary.tsx` | 已完成 |
| 3. 物种信息显示 | ✅ 已完成 | `character-sheet/page.tsx`, `CharacterSheetSummary.tsx` | 已完成 |
| 4. 熟练加值说明 | ✅ 已完成 | `character-sheet/page.tsx` | 已完成 |
| 5. 武器系统 | 🔄 进行中 | 多个文件 | 2-3小时 |
| 6. AC护甲计算 | ⏳ 待开发 | 依赖武器系统 | 1-2小时 |

---

## 🧪 测试场景

### 测试场景1：木精灵吟游诗人

```
⚠️ 强制刷新：Cmd+Shift+R (Mac) 或 Ctrl+Shift+R (Windows)

1. http://localhost:3000

2. 创建角色：
   → 吟游诗人 + 流浪者背景

3. 步骤2.2：选择精灵物种
   → 选择"木精灵（速度35尺...）"血统
   → 选择"生存（感知）- 追踪、狩猎..."技能
   → 完成

4. 完成所有步骤

5. 步骤7：查看角色信息汇总
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   【检查点】
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ✅ 物种显示："精灵 - 木精灵"
   ✅ 移动速度：35尺
   ✅ 技能列表包含：
      • 洞悉（流浪者背景）
      • 隐匿（流浪者背景）
      • 生存（精灵物种）← 新增！
      • 杂技、奥秘、表演（吟游诗人职业）

6. 点击"查看网页版角色卡"
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   【检查点】
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ✅ 左上角：
      吟游诗人 1 • 精灵 - 木精灵 • 流浪者
      （不再是"ne"）
   
   ✅ 右上角熟练加值：
      熟练加值
      +2
      Proficiency Bonus
   
   ✅ 速度：35 尺
   
   ✅ 技能部分：
      • 生存 ●（熟练标记）
```

### 测试场景2：人类圣武士

```
1. 创建：圣武士 + 士兵背景 + 人类

2. 人类物种技能选择：
   → 选择"竞技（力量）"
   → 完成

3. 查看角色信息：
   ✅ 物种显示："人类"
   ✅ 移动速度：30尺
   ✅ 技能列表包含：
      • 运动（士兵背景）
      • 威吓（士兵背景）
      • 竞技（人类物种）← 新增！
      • 洞悉、宗教（圣武士职业）
```

---

## 🔄 下一步计划

### 方案A：完整实现武器和护甲系统

**优点**：
- 完整的游戏体验
- 符合D&D 2024规则
- 角色卡信息完整

**缺点**：
- 需要2-4小时开发时间
- 较多UI和逻辑工作
- 需要测试多种组合

**包含内容**：
1. 扩展角色数据模型
2. 创建武器选择UI
3. 创建护甲选择UI
4. 在角色卡上显示武器栏位
5. 更新AC计算逻辑
6. 整合到角色创建流程

---

### 方案B：简化版本（先显示背景装备中的武器）

**优点**：
- 快速实现（30分钟）
- 减少选择步骤
- 基于现有装备数据

**缺点**：
- 无法自由选择武器
- 武器信息不完整
- 不符合完整规则

**包含内容**：
1. 解析背景装备中的武器名称
2. 匹配武器数据库
3. 在角色卡上显示基本攻击信息
4. 暂不考虑武器精通

---

### 方案C：分阶段实现

**阶段1（30分钟）**：
- 显示背景装备中的武器基本信息
- 简单的攻击加值计算

**阶段2（1-2小时）**：
- 添加武器选择UI
- 完整的攻击计算

**阶段3（1小时）**：
- 护甲选择和AC计算
- 武器精通详细说明

---

## ✅ 当前状态

**已完成**：
- ✅ 物种技能添加逻辑
- ✅ 木精灵速度35尺
- ✅ 物种子类型显示
- ✅ 熟练加值说明
- ✅ 武器和护甲数据库创建

**编译状态**：✅ 成功  
**可测试**：✅ 前4项修复可立即测试

**待讨论**：武器和护甲系统的实现方案

---

## 💬 建议

**建议采用方案C（分阶段实现）**：
1. **现在**：用户可以测试前4项修复
2. **阶段1**：我可以快速实现武器基本显示
3. **阶段2-3**：根据用户反馈决定是否需要完整功能

这样可以：
- ✅ 快速解决最critical的问题
- ✅ 避免过度开发不需要的功能
- ✅ 根据实际使用情况调整优先级

---

**状态**：✅ 前4项已修复，可立即测试  
**武器系统**：🔄 数据库已就绪，等待实现方案确认

**现在可以测试木精灵的生存技能和35尺速度了！** 🎯✨
