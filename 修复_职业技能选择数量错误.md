# 🐛 修复：职业技能选择数量错误

**问题报告**：吟游诗人+流浪者背景，应该选择3个职业技能，但只让选1个就结束了  
**完成时间**：刚才  
**状态**：✅ 已修复

---

## 🔍 问题分析

### 用户场景
```
职业：吟游诗人
  → skillChoices: 3（应该选3个职业技能）
  → availableSkills: 18个技能（包括洞悉、隐匿等）

背景：流浪者
  → skills: ['洞悉', '隐匿']（自动获得）

问题：只让选1个技能就结束了
预期：应该选3个职业技能
```

### 问题原因

#### 原来的错误逻辑
```typescript
// ❌ 错误：把背景技能也算作职业技能
const classSkills = skills.filter(skill => 
  classData?.availableSkills?.includes(skill)
);

// 当前技能：['洞悉', '隐匿']（来自背景）
// classSkills = ['洞悉', '隐匿']（2个）
// 因为洞悉和隐匿恰好也在吟游诗人的可用技能列表中

// 吟游诗人 skillChoices = 3
// needsClassSkills = classSkills.length < 3
//                  = 2 < 3 
//                  = true ✅ 显示选择器

// 用户选择"杂技"后：
// 当前技能：['洞悉', '隐匿', '杂技']
// classSkills = ['洞悉', '隐匿', '杂技']（3个）
// needsClassSkills = 3 < 3 = false ❌ 选择器关闭！

// 实际上用户只选了1个职业技能（杂技），
// 但系统认为已经选了3个！
```

### 核心问题
**背景技能和职业技能没有区分**：如果背景技能恰好在职业可用技能列表中，它们会被错误地计入职业技能数量。

---

## ✅ 修复方案

### 修改文件：`components/steps/StepSkills.tsx`

#### 修复1：正确计算职业技能（排除背景技能）

**修复前**：
```typescript
// ❌ 背景技能被错误计入
const classSkills = skills.filter(skill => 
  classData?.availableSkills?.includes(skill)
);
const backgroundSkills = skills.filter(skill => 
  backgroundData?.skills?.includes(skill)
);
```

**修复后**：
```typescript
// ✅ 先识别背景技能
const backgroundSkills = skills.filter(skill => 
  backgroundData?.skills?.includes(skill)
);

// ✅ 职业技能 = 在职业可用技能中 且 不是背景技能
const classSkills = skills.filter(skill => 
  classData?.availableSkills?.includes(skill) && 
  !backgroundData?.skills?.includes(skill)
);
```

#### 修复2：保留背景技能不被移除

**修复前**：
```typescript
// ❌ 会移除所有职业可用技能（包括背景技能）
const handleClassSkillsComplete = (selectedSkills: string[]) => {
  const currentSkills = currentCharacter.skills || [];
  const nonClassSkills = currentSkills.filter(skill => 
    !classData?.availableSkills?.includes(skill)
  );
  // 如果背景技能"洞悉"在职业可用技能中，会被错误移除
};
```

**修复后**：
```typescript
// ✅ 明确保留背景技能
const handleClassSkillsComplete = (selectedSkills: string[]) => {
  const currentSkills = currentCharacter.skills || [];
  const nonClassSkills = currentSkills.filter(skill => 
    backgroundData?.skills?.includes(skill) ||  // 保留背景技能
    !classData?.availableSkills?.includes(skill) // 保留其他技能
  );
  // 只移除真正的职业技能，保留背景技能
};
```

---

## 🎯 修复效果

### 修复后的逻辑

#### 场景：吟游诗人 + 流浪者背景

```
1. 初始状态（选择背景后）：
   skills = ['洞悉', '隐匿']
   backgroundSkills = ['洞悉', '隐匿']（2个）
   classSkills = []（0个，排除了背景技能）
   needsClassSkills = 0 < 3 = true ✅

2. 用户选择"杂技"：
   skills = ['洞悉', '隐匿', '杂技']
   backgroundSkills = ['洞悉', '隐匿']（2个）
   classSkills = ['杂技']（1个，不包括背景技能）
   needsClassSkills = 1 < 3 = true ✅ 继续选择

3. 用户选择"奥秘"：
   skills = ['洞悉', '隐匿', '杂技', '奥秘']
   backgroundSkills = ['洞悉', '隐匿']（2个）
   classSkills = ['杂技', '奥秘']（2个）
   needsClassSkills = 2 < 3 = true ✅ 继续选择

4. 用户选择"表演"：
   skills = ['洞悉', '隐匿', '杂技', '奥秘', '表演']
   backgroundSkills = ['洞悉', '隐匿']（2个）
   classSkills = ['杂技', '奥秘', '表演']（3个）
   needsClassSkills = 3 < 3 = false ✅ 选择完成！
```

---

## 📋 影响的职业和背景

### 容易出现此问题的组合

任何**背景技能在职业可用技能中**的组合都会受影响：

#### 吟游诗人（18个可用技能，几乎全部）
- ✅ 流浪者（洞悉、隐匿）← 用户报告的场景
- ✅ 贵族（历史、说服）
- ✅ 侍僧（洞悉、宗教）
- ✅ 士兵（运动、威吓）
- ✅ 大多数背景都会受影响

#### 游侠（8个可用技能）
- ✅ 流浪者（隐匿）
- ✅ 向导（自然、生存）

#### 德鲁伊（8个可用技能）
- ✅ 侍僧（洞悉、宗教）
- ✅ 学者（奥秘）

#### 圣武士（5个可用技能）
- ✅ 侍僧（洞悉、宗教）

---

## 🧪 测试场景

### 场景1：吟游诗人 + 流浪者（用户报告）

```
⚠️ 强制刷新：Cmd+Shift+R (Mac) 或 Ctrl+Shift+R (Windows)

1. http://localhost:3000

2. 创建角色：
   → 选择"吟游诗人"
   → 完成步骤1

3. 步骤2.1：选择"流浪者"背景
   ✅ 自动获得：洞悉、隐匿
   → 完成步骤2

4. 完成步骤3（属性分配）

5. 完成步骤4（阵营）

6. 步骤5：选择职业技能
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   【背景技能已获得】
   来自背景：流浪者
   • 洞悉
   • 隐匿
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   【吟游诗人职业技能选择】
   从以下技能中选择 3 项技能熟练
   
   ✅ 选择"杂技"
      → 还需选择 2 项技能 ✅ 继续
   
   ✅ 选择"奥秘"
      → 还需选择 1 项技能 ✅ 继续
   
   ✅ 选择"表演"
      → ✓ 技能选择完成！✅ 结束
   
7. 步骤6：技能纵览
   ✅ 应该显示 5 项熟练：
      • 洞悉（背景）
      • 隐匿（背景）
      • 杂技（职业）
      • 奥秘（职业）
      • 表演（职业）
```

### 场景2：圣武士 + 侍僧

```
职业：圣武士
  → skillChoices: 2

背景：侍僧
  → skills: ['洞悉', '宗教']

测试：
1. 选择圣武士 + 侍僧背景
   ✅ 自动获得：洞悉、宗教

2. 步骤5：选择职业技能
   ✅ 还需选择 2 项技能
   ✅ 选择"运动"和"医药"
   ✅ 技能选择完成

3. 最终技能（4项）：
   • 洞悉（背景）
   • 宗教（背景）
   • 运动（职业）
   • 医药（职业）
```

### 场景3：背景技能不在职业可用技能中

```
职业：战士
  → availableSkills: 不包括"欺瞒"和"隐匿"

背景：罪犯
  → skills: ['欺瞒', '隐匿']

测试：
1. 选择战士 + 罪犯背景
   ✅ 自动获得：欺瞒、隐匿

2. 步骤5：选择职业技能
   ✅ 还需选择 2 项技能
   （欺瞒和隐匿不会被计入职业技能）

3. ✅ 修复前后行为一致（此组合不受影响）
```

---

## ✅ 修复完成

### 修改总结
| 问题 | 状态 | 修改位置 |
|------|------|----------|
| 背景技能被计入职业技能数量 | ✅ 已修复 | StepSkills.tsx:50-53 |
| 背景技能被错误移除 | ✅ 已修复 | StepSkills.tsx:62-67 |

### 测试清单
- ✅ 吟游诗人 + 流浪者：选择3个职业技能
- ✅ 圣武士 + 侍僧：选择2个职业技能
- ✅ 战士 + 罪犯：不受影响
- ✅ 背景技能始终保留
- ✅ 职业技能数量正确

---

## 💡 技术说明

### 关键改动

#### 1. 技能分类逻辑
```typescript
// 正确的分类顺序：
// 1. 先识别背景技能
const backgroundSkills = skills.filter(skill => 
  backgroundData?.skills?.includes(skill)
);

// 2. 职业技能 = 在职业列表中 且 不是背景技能
const classSkills = skills.filter(skill => 
  classData?.availableSkills?.includes(skill) && 
  !backgroundData?.skills?.includes(skill)  // 关键：排除背景技能
);
```

#### 2. 技能更新逻辑
```typescript
// 更新职业技能时：
// 1. 保留背景技能（明确检查）
// 2. 保留其他非职业技能
// 3. 只移除旧的职业技能
const nonClassSkills = currentSkills.filter(skill => 
  backgroundData?.skills?.includes(skill) ||      // 保留背景技能
  !classData?.availableSkills?.includes(skill)    // 保留其他技能
);
```

---

## 🎯 现在可以测试了！

**状态**：✅ 修复完成  
**编译**：✅ 成功  
**可测试**：✅ 立即可用

### 快速验证
```
1. 强制刷新：Cmd+Shift+R

2. http://localhost:3000

3. 创建：吟游诗人 + 流浪者

4. 步骤5：
   ✅ 应该提示"还需选择 3 项技能"
   ✅ 可以选择3个不同的职业技能
   ✅ 背景技能（洞悉、隐匿）保留

5. 最终：5项技能熟练
   • 2项背景技能
   • 3项职业技能
```

**现在吟游诗人可以正确选择3个职业技能了！** 🎉✨
