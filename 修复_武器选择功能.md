# 🐛 修复：武器选择功能

**问题报告**：
1. 装备选择页面只有简单武器可以选择
2. 选择了的武器也没有出现在最后的网页版角色卡上

**完成时间**：刚才  
**状态**：✅ 已修复

---

## 🔍 问题分析

### 问题1：只有简单武器可以选择

**原因**：
- 装备选择器（EquipmentSelector）只让用户选择装备包（选项A）或金币（选项B）
- 装备包中可能只有简单武器（如匕首）
- 没有提供武器选择界面，让用户根据职业熟练项选择武器

### 问题2：选择的武器不显示

**原因**：
- 角色数据模型中没有存储用户选择的武器
- 网页版角色卡只从背景装备中提取武器
- 如果用户选择50金币，就没有武器显示

---

## ✅ 修复方案

### 修复1：创建武器选择组件

**新建文件**：`components/WeaponSelector.tsx`

**功能特性**：
- 根据职业武器熟练项过滤可用武器
- 支持简易武器和军用武器
- 显示武器详细信息（伤害、属性、精通）
- 支持多选
- 按武器类型分组显示

**关键逻辑**：
```typescript
// 根据职业熟练项过滤武器
const getAvailableWeapons = (): Weapon[] => {
  const weaponProfs = classData.proficiencies.weapons;
  const availableWeapons: Weapon[] = [];

  WEAPONS.forEach(weapon => {
    let isProficient = false;

    // 检查"简易武器"或"军用武器"
    if (weaponProfs.includes('简易武器') && weapon.category.includes('简易')) {
      isProficient = true;
    }
    if (weaponProfs.includes('军用武器') && weapon.category.includes('军用')) {
      isProficient = true;
    }

    // 检查具体武器名称
    if (weaponProfs.some(w => weapon.category.includes(w) || weapon.name.includes(w))) {
      isProficient = true;
    }

    if (isProficient) {
      availableWeapons.push(weapon);
    }
  });

  return availableWeapons;
};
```

### 修复2：更新角色数据模型

**修改文件**：`lib/character-store.ts`

添加 `equippedWeapons` 字段：
```typescript
const createEmptyCharacter = (): Partial<Character> => ({
  // ... 其他字段
  equippedWeapons: [] // 用户选择的武器（武器ID数组）
});
```

### 修复3：在装备选择流程中添加武器选择步骤

**修改文件**：`components/steps/StepOriginBackground.tsx`

**流程改进**：
```
选择背景
  ↓
选择装备（选项A或B）
  ↓
选择武器（新增！）← 无论选择A还是B都显示
  ↓
分配属性加值
```

**关键修改**：
```typescript
const handleEquipmentComplete = (choice: 'A' | 'B') => {
  updateCurrentCharacter({
    backgroundEquipmentChoice: choice
  });
  // 无论选择装备包还是金币，都显示武器选择器
  setShowWeaponSelector(true);
  setShowAbilityBonus(false);
};

const handleWeaponComplete = (weaponIds: string[]) => {
  updateCurrentCharacter({
    equippedWeapons: weaponIds
  });
  // 武器选择完成后，显示属性加值选择
  setShowAbilityBonus(true);
};
```

### 修复4：更新网页版角色卡显示逻辑

**修改文件**：
- `app/character-sheet/page.tsx`
- `components/CharacterSheetSummary.tsx`

**显示优先级**：
```typescript
// 优先使用用户选择的武器
if (character.equippedWeapons && character.equippedWeapons.length > 0) {
  for (const weaponId of character.equippedWeapons) {
    const weapon = WEAPONS.find(w => w.id === weaponId);
    if (weapon) {
      equippedWeapons.push({ weapon, quantity: 1 });
    }
  }
}
// 如果没有用户选择的武器，从背景装备中提取
else if (selectedEquipment && 'items' in selectedEquipment) {
  for (const item of selectedEquipment.items) {
    const weapon = getWeaponByName(item.name);
    if (weapon) {
      equippedWeapons.push({ weapon, quantity: item.quantity });
    }
  }
}
```

---

## 🎯 修复效果

### 现在的流程

#### 场景1：选择装备包（选项A）

```
1. 选择背景：流浪者
2. 选择装备：选项A（装备包）
   → 包含：2×匕首、盗贼工具、撬棍...
3. 选择武器（新增！）
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   根据职业熟练项显示所有可用武器：
   
   【简易近战武器】
   • 木棒、匕首、手斧、标枪...
   
   【简易远程武器】
   • 轻弩、短弓、投石索
   
   【军用近战武器】（如果职业熟练）
   • 长剑、细剑、短剑、战锤...
   
   【军用远程武器】（如果职业熟练）
   • 长弓、手弩、重弩
   
   ✅ 可以选择多把武器
   ✅ 显示武器详细信息
   ✅ 显示武器精通效果
4. 分配属性加值
```

#### 场景2：选择50金币（选项B）

```
1. 选择背景：任意
2. 选择装备：选项B（50金币）
3. 选择武器（新增！）
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   显示所有根据职业熟练的可用武器
   ✅ 可以选择任意数量的武器
4. 分配属性加值
```

### 网页版角色卡显示

**现在会显示**：
```
⚔️ 武器

[长剑]
军用近战武器

攻击命中        伤害
  +5         1d8+3 挥砍
属性 + 熟练

属性：多用途（1d10）

✨ 武器精通：Vex
烦扰：命中时下次对目标攻击有优势

[短弓]
简易远程武器

攻击命中        伤害
  +4         1d6+2 穿刺
属性 + 熟练

属性：弹药（80/320）、双手

✨ 武器精通：Vex
烦扰：命中时下次对目标攻击有优势
```

---

## 📋 武器选择器功能

### 显示内容

1. **武器分类**：
   - 简易近战武器
   - 简易远程武器
   - 军用近战武器（如果职业熟练）
   - 军用远程武器（如果职业熟练）

2. **武器信息**：
   - 武器名称（中英文）
   - 伤害骰和伤害类型
   - 武器属性（灵巧、轻型、投掷等）
   - 武器精通效果

3. **选择状态**：
   - 已选择武器数量
   - 已选择武器列表
   - 多选支持

### 根据职业过滤

#### 吟游诗人
- 熟练项：简易武器、手弩、长剑、细剑、短剑
- 可用武器：
  - ✅ 所有简易武器
  - ✅ 手弩、长剑、细剑、短剑
  - ❌ 其他军用武器（不熟练）

#### 战士
- 熟练项：简易武器、军用武器
- 可用武器：
  - ✅ 所有简易武器
  - ✅ 所有军用武器

#### 游荡者
- 熟练项：简易武器、短剑
- 可用武器：
  - ✅ 所有简易武器
  - ✅ 短剑
  - ❌ 其他军用武器（不熟练）

---

## 🧪 测试场景

### 测试场景1：吟游诗人 + 流浪者 + 选择装备包

```
⚠️ 强制刷新：Cmd+Shift+R

1. 创建角色：吟游诗人 + 流浪者

2. 步骤2.1：选择背景
   → 选择"流浪者"
   → 完成

3. 选择装备：选项A（装备包）
   ✅ 显示装备包内容：2×匕首、盗贼工具...

4. 选择武器（新增步骤！）
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   【检查点】
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ✅ 显示职业：吟游诗人
   ✅ 显示熟练项：简易武器、手弩、长剑、细剑、短剑
   
   ✅ 显示武器分类：
      • 简易近战武器（木棒、匕首、手斧...）
      • 简易远程武器（轻弩、短弓、投石索）
      • 军用近战武器（长剑、细剑、短剑）
      • 军用远程武器（手弩）
   
   ✅ 每个武器显示：
      • 名称（中英文）
      • 伤害：1dX 类型
      • 属性：灵巧、轻型等
      • 武器精通：效果名称
   
   → 选择"长剑"
   → 选择"短弓"
   → 完成

5. 分配属性加值
   → 完成

6. 查看网页版角色卡第2页：
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   【检查点】
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ✅ 武器栏位显示：
      • 长剑（用户选择的）
      • 短弓（用户选择的）
      • 匕首（装备包中的，如果也显示）
   
   ✅ 每个武器显示完整信息：
      • 攻击命中加值
      • 伤害
      • 武器精通效果
```

### 测试场景2：战士 + 选择50金币

```
1. 创建角色：战士 + 任意背景

2. 选择装备：选项B（50金币）

3. 选择武器：
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   【检查点】
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ✅ 显示所有武器（战士熟练所有武器）
      • 简易近战武器（全部）
      • 简易远程武器（全部）
      • 军用近战武器（全部）
      • 军用远程武器（全部）
   
   → 选择"巨剑"
   → 选择"长弓"
   → 完成

4. 查看网页版角色卡：
   ✅ 显示：巨剑、长弓
   ✅ 完整武器信息
```

---

## ✅ 修复完成

### 修改总结

| 问题 | 状态 | 修改文件 |
|------|------|----------|
| 只有简单武器可选 | ✅ 已修复 | 新建`WeaponSelector.tsx` |
| 选择的武器不显示 | ✅ 已修复 | `character-store.ts`, `character-sheet/page.tsx`, `CharacterSheetSummary.tsx` |
| 武器选择流程 | ✅ 已修复 | `StepOriginBackground.tsx` |

### 新增功能

1. ✅ **武器选择组件**：根据职业熟练项显示所有可用武器
2. ✅ **武器数据存储**：保存到角色数据中
3. ✅ **武器显示**：网页版角色卡显示用户选择的武器
4. ✅ **完整信息**：攻击、伤害、精通效果

---

## 🎯 现在可以测试了！

**状态**：✅ 修复完成  
**编译**：✅ 成功  
**测试**：✅ 立即可用

### 快速验证（3分钟）
```
1. 强制刷新：Cmd+Shift+R

2. 创建角色：吟游诗人 + 流浪者
   → 选择装备"选项A"或"选项B"

3. 步骤2：选择武器
   ✅ 应该看到所有根据职业熟练的武器
   ✅ 包括简易武器和军用武器（如果职业熟练）
   ✅ 可以选择多把武器

4. 完成所有步骤

5. 查看网页版角色卡：
   ✅ 应该显示你选择的武器
   ✅ 显示完整的攻击、伤害、精通信息
```

**现在可以选择所有可用武器，并在角色卡上完整显示了！** 🎉✨
