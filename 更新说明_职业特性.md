# 更新说明 - 职业特性选择功能

## 🐛 修复的问题

### 1. 背景选择器报错 ✅
**问题**：选择背景时出现错误
**原因**：`useEffect` 依赖项包含 `onComplete` 函数，导致重复调用
**解决方案**：
- 使用 `useRef` 追踪是否已调用回调
- 添加数据安全检查
- 防止重复调用导致的状态循环

### 2. 技能选择器优化 ✅
**改进**：
- 同样修复了职业技能选择器的 `useEffect` 问题
- 添加了更完善的错误处理
- 优化了初始技能过滤逻辑

## ✨ 新增功能：职业特性选择

### 功能概述
在选择职业和技能后，某些职业需要进行额外的特性选择（如牧师的圣职、战士的战斗风格等）。

### 实现的职业特性

#### 1. **牧师 (Cleric)** - 圣职选择
- **守护者 (Protector)**
  - 获得军用武器熟练
  - 获得重甲熟练
  - 适合近战战斗的牧师

- **奇术师 (Thaumaturge)**
  - 额外学习1个牧师戏法
  - 奥秘和宗教检定加上感知调整值
  - 适合施法为主的牧师

#### 2. **战士 (Fighter)** - 战斗风格
- **箭术**：远程武器攻击+2
- **防御**：穿护甲时AC+1
- **决斗**：单手武器伤害+2
- **巨武器战斗**：双手武器伤害骰1-2可重投
- **保护**：保护5尺内盟友
- **双武器战斗**：副手攻击加属性调整值

#### 3. **邪术师 (Warlock)** - 契约恩赐
- **锁链契约**：召唤特殊魔宠
- **刀锋契约**：召唤契约武器，用魅力攻击
- **魔典契约**：获得暗影之书，学习额外戏法

#### 4. **术士 (Sorcerer)** - 术士起源
- **龙裔血统**：龙族抗性，AC提升
- **狂野魔法**：狂野魔法涌动，潮涌骰
- **风暴术士**：施法后飞行，雷电抗性

### 工作流程

```
选择职业
    ↓
选择职业技能（2-4项）
    ↓
[新增] 选择职业特性（如果该职业有）
    ↓
完成职业设置
```

### 用户界面

1. **特性选择器**
   - 紫色主题（区别于技能的蓝色）
   - 卡片式选项布局
   - 显示每个选项的详细收益
   - 实时反馈选择状态

2. **审核页面**
   - 新增"职业特性选择"区域
   - 显示已选择的特性和收益
   - 紫色高亮显示

3. **PDF导出**
   - 包含职业特性选择
   - 显示特性名称和选择的选项

## 🔧 技术实现

### 新增组件
```typescript
ClassFeatureSelector.tsx
- 职业特性选择器组件
- 支持多选项选择
- 显示详细的收益列表
- useRef 防止重复调用
```

### 数据结构更新
```typescript
// Character 接口
classFeatureChoices?: Record<string, string>
// 例如：{"divineOrder": "protector", "fightingStyle": "defense"}

// 职业数据
featureChoices?: ClassFeatureChoice[]
// 包含特性ID、名称、等级和选项列表
```

### 状态管理
- 在 `StepClass` 中添加 `showFeatureSelector` 状态
- 技能选择完成后检查是否需要特性选择
- 特性选择结果保存到 `character.classFeatureChoices`

## 📱 用户体验

### 引导流程
1. ✅ 选择职业后立即选择技能
2. ✅ 技能选择完成后，如果该职业有特性，自动显示特性选择
3. ✅ 所有选择完成后显示绿色完成提示
4. ✅ 可以随时返回重新选择职业

### 视觉设计
- 🔵 **蓝色**：技能选择
- 🟣 **紫色**：职业特性选择
- 🟢 **绿色**：完成状态
- 🔴 **红色**：主色调和重要信息

## 🎯 测试检查项

### 功能测试
- [ ] 选择牧师 → 技能选择 → 圣职选择
- [ ] 选择战士 → 技能选择 → 战斗风格选择
- [ ] 选择邪术师 → 技能选择 → 契约选择
- [ ] 选择术士 → 技能选择 → 起源选择
- [ ] 选择其他职业（无特性选择） → 直接完成

### 数据持久化
- [ ] 刷新页面后特性选择保留
- [ ] 编辑角色时特性选择正确显示
- [ ] PDF导出包含特性选择

### 错误处理
- [ ] 背景选择不再报错
- [ ] 职业选择流程顺畅
- [ ] 重新选择职业正确清除状态

## 📊 更新统计

- **新增组件**：1个（ClassFeatureSelector）
- **修复组件**：2个（ClassSkillSelector, BackgroundSkillSelector）
- **更新组件**：2个（StepClass, StepReview）
- **新增职业特性**：4个职业（牧师、战士、邪术师、术士）
- **特性选项总数**：14个选项

## 🚀 后续扩展

可以继续添加的职业特性：
- [ ] 吟游诗人 - 吟游诗人学院
- [ ] 德鲁伊 - 德鲁伊环
- [ ] 武僧 - 武术传统
- [ ] 圣武士 - 神圣誓约（3级）
- [ ] 游侠 - 游侠原型（3级）
- [ ] 游荡者 - 游荡者原型（3级）
- [ ] 法师 - 奥术传统（2级）

## 💡 使用提示

### 创建牧师示例
1. 选择"牧师"职业
2. 从5个技能中选择2个（如：洞悉、宗教）
3. 选择圣职：
   - 近战型：选择"守护者"
   - 施法型：选择"奇术师"
4. 继续后续步骤

### 创建战士示例
1. 选择"战士"职业
2. 从8个技能中选择2个（如：竞技、察觉）
3. 选择战斗风格：
   - 弓箭手：选择"箭术"
   - 坦克：选择"防御"
   - 双持：选择"双武器战斗"
4. 继续后续步骤

## 🔍 故障排除

### 如果遇到错误
1. **清除浏览器缓存**：Ctrl+Shift+R（Windows）或 Cmd+Shift+R（Mac）
2. **检查控制台**：F12 打开开发者工具，查看 Console 标签
3. **重新开始**：点击"重新选择职业"返回开始

### 常见问题
Q: 为什么我的职业没有特性选择？
A: 目前只有牧师、战士、邪术师和术士有1级特性选择。其他职业可能在更高等级才有子职业选择。

Q: 可以改变特性选择吗？
A: 可以！点击"重新选择职业"返回，重新进行选择。

Q: 特性选择会影响属性吗？
A: 是的！某些选择会提供熟练项或AC加值，这些会在角色卡上体现。

---

**更新已完成！** 🎉

现在可以创建更完整、更符合规则的DND 2024角色了！
