# 🚀 方案A：完全遵循官方流程重构 - 实施计划

## 📋 总览

**目标**：完全按照 D&D Beyond 2024 官方流程重构角色创建系统

**预计时间**：2-3周

**官方5步流程**：
1. Choose a Class
2. Determine Origin (Background + Species + Languages)
3. Determine Ability Scores
4. Choose an Alignment
5. Fill In Details

---

## 🎯 阶段1：准备数据（2-3天）

### 任务1.1：创建专长（Feats）数据文件 ⭐
**文件**：`lib/feats-data.ts`

**内容**：
- 75个起源专长（Origin Feats）
- 至少实现基础规则中的关键专长
- 专长结构：
  ```typescript
  interface Feat {
    id: string;
    name: string;
    nameEn: string;
    type: 'origin' | 'general' | 'epic';
    category?: string;
    description: string;
    prerequisite?: string;
    repeatable?: boolean;
    benefits: string[];
  }
  ```

**重点专长（优先）**：
- Magic Initiate (Cleric/Druid/Wizard) - 背景需要
- Alert - 罪犯背景
- Savage Attacker - 士兵背景
- Skilled - 人类推荐
- Healer - 隐士背景
- Lucky - 多个背景
- Tavern Brawler - 水手背景

### 任务1.2：更新背景数据
**文件**：`lib/dnd-data.ts`

**添加字段**：
- `narrative: string` - 背景故事
- `feat: string` - 专长ID
- `equipmentOptions` - 装备选项A/B

**16个背景全部更新**

### 任务1.3：创建语言数据
**文件**：`lib/languages-data.ts`

**内容**：
- 标准语言（12种）
- 稀有语言（9种）
- 语言结构：
  ```typescript
  interface Language {
    id: string;
    name: string;
    nameEn: string;
    type: 'standard' | 'rare';
    origin: string;
    description: string;
    script?: string;
  }
  ```

### 任务1.4：创建装备包数据
**文件**：`lib/equipment-packages-data.ts`

**内容**：
- 每个背景的装备包A详细内容
- 装备包B（50金币）

### 任务1.5：更新物种数据
**添加字段**：
- `lore: string` - 起源故事
- `lifespan: number` - 寿命
- `maturity: number` - 成年年龄
- 标注特质的等级要求

---

## 🔧 阶段2：重构数据结构（1天）

### 任务2.1：更新Character接口
**文件**：`lib/dnd-data.ts`

```typescript
export interface Character {
  // ... 现有字段
  
  // 新增字段
  languages: string[];  // 语言列表
  feats: string[];      // 专长ID列表
  
  // 背景相关
  backgroundEquipmentChoice?: 'A' | 'B';
  backgroundFeat?: string;
  
  // 改进字段
  skills: SkillProficiency[];
  
  // 职业相关
  classSkills?: string[]; // 移到这里统一管理
}

interface SkillProficiency {
  name: string;
  proficient: boolean;
  source: 'class' | 'background' | 'feat' | 'species';
  bonus?: number;
}
```

### 任务2.2：更新Background接口
```typescript
export interface Background {
  id: string;
  name: string;
  nameEn: string;
  description: string;
  narrative: string; // ⭐ 新增
  
  // 属性
  abilityBonus: 3;
  abilityChoices: string[];
  
  // 专长 ⭐ 新增
  feat: string;
  
  // 技能和工具
  skills: string[];
  toolProficiency: string;
  
  // 装备 ⭐ 改进
  equipmentOptions: {
    optionA: {
      items: Array<{ name: string; quantity: number }>;
      gold?: number;
    };
    optionB: {
      gold: number;
    };
  };
}
```

### 任务2.3：更新Species接口
```typescript
export interface Species {
  // ... 现有字段
  
  // 新增字段
  lore: string;      // 起源故事
  lifespan: number;  // 寿命（年）
  maturity: number;  // 成年年龄
  
  // 改进特质
  traits: Array<{
    name: string;
    description: string;
    levelRequirement?: number; // ⭐ 新增
  }>;
}
```

### 任务2.4：更新Store
**文件**：`lib/character-store.ts`

- 添加新字段的初始化
- 更新createEmptyCharacter函数
- 添加专长、语言的管理方法

---

## 🎨 阶段3：创建新组件（2-3天）

### 任务3.1：专长组件
**文件**：`components/FeatDisplay.tsx`

**功能**：
- 显示专长名称、描述、效果
- 可展开查看详情
- 来源标注（背景/人类/等级提升）

### 任务3.2：语言选择组件
**文件**：`components/LanguageSelector.tsx`

**功能**：
- 自动显示通用语
- 选择2个标准语言
- 显示语言表格（可投骰或选择）
- 显示语言来源和说明

### 任务3.3：装备选择组件
**文件**：`components/EquipmentSelector.tsx`

**功能**：
- 显示背景装备的A/B两个选项
- 选项A：显示详细装备列表
- 选项B：显示金币数量
- 单选框界面

### 任务3.4：技能汇总组件
**文件**：`components/SkillsSummary.tsx`

**功能**：
- 显示所有技能来源
- 分类显示：职业/背景/专长/物种
- 显示熟练加值
- 显示总调整值

### 任务3.5：专长选择组件（人类用）
**文件**：`components/FeatSelector.tsx`

**功能**：
- 显示所有起源专长
- 过滤和搜索
- 显示前置条件
- 选择界面

---

## 🔄 阶段4：重构步骤流程（3-4天）

### 任务4.1：重新设计步骤结构

**新的STEPS数组**：
```typescript
const STEPS = [
  { id: 'welcome', name: '欢迎', icon: '👋' },
  { id: 'class', name: '选择职业', icon: '⚔️' },
  { id: 'origin', name: '确定起源', icon: '📜', 
    substeps: ['background', 'species', 'languages'] },
  { id: 'abilities', name: '确定属性', icon: '💪' },
  { id: 'alignment', name: '选择阵营', icon: '⚖️' },
  { id: 'details', name: '填写细节', icon: '📝',
    substeps: ['class-features', 'skills', 'equipment', 'spells'] },
  { id: 'review', name: '审核完成', icon: '✅' }
];
```

### 任务4.2：步骤0 - 欢迎页面
**文件**：`components/steps/StepWelcome.tsx`

**内容**：
- 欢迎信息
- 流程说明
- 可选：角色名称输入
- "开始创建"按钮

### 任务4.3：步骤1 - 选择职业（简化）
**文件**：`components/steps/StepClass.tsx`（重构）

**改动**：
- ❌ 移除技能选择（移到步骤5）
- ❌ 移除特性选择（移到步骤5）
- ✅ 只显示职业卡片和说明
- ✅ 显示职业的关键信息：
  - 主要属性
  - 生命骰
  - 复杂度
  - 职业描述
- ✅ 点击查看更多详情（不做选择）

### 任务4.4：步骤2 - 确定起源（新结构）
**文件**：`components/steps/StepOrigin.tsx`（新建）

**子步骤导航**：
```
[背景] → [物种] → [语言]
```

**2.1 选择背景**
**文件**：`components/steps/StepOriginBackground.tsx`

**显示内容**：
- 16个背景卡片
- 每个卡片显示：
  - 背景名称
  - 📖 背景故事（展开）
  - 🎯 属性选项（3个）
  - ⭐ 提供的专长
  - 🎯 技能（2个固定）
  - 🔧 工具
  - 🎒 装备选项预览

**选择后的子步骤**：
1. 装备选择（A或B）
2. 属性选项确认（哪3个属性，稍后分配）

**2.2 选择物种**
**文件**：`components/steps/StepOriginSpecies.tsx`（重构现有的）

**改进**：
- 添加物种故事（可展开）
- 显示寿命信息
- 特质标注等级要求
- 物种选择后的特性选择保持现有逻辑

**2.3 选择语言**
**文件**：`components/steps/StepOriginLanguages.tsx`（新建）

**内容**：
- 显示：已自动获得通用语
- 选择2个标准语言
- 语言表格（带投骰选项）
- 显示每种语言的来源和用途说明

### 任务4.5：步骤3 - 确定属性值（改进）
**文件**：`components/steps/StepAbilities.tsx`（重构）

**改进的流程**：

**页面1：选择方法和分配基础属性**
```
选择方法：[标准数组] 购点法 手动输入
    ↓
分配基础属性
    ↓
[继续到背景调整]
```

**页面2：背景属性调整**（同页面或下一页）
```
💡 你的背景（士兵）提供 +3 点
   可以加到：力量、敏捷、体质

分配模式：[+2/+1] +1/+1/+1

力量  15 + [2] = 17
敏捷  14 + [0] = 14  
体质  13 + [1] = 14

已分配：3/3 ✓
```

**关键改进**：
- 两个调整在同一个步骤中完成
- 清晰显示"基础值 + 背景加值 = 最终值"
- 实时预览最终属性

### 任务4.6：步骤4 - 选择阵营（移动）
**文件**：`components/steps/StepAlignment.tsx`（新建）

**内容**：
- 9种阵营选项
- 每种阵营的详细说明
- 个性特质关联表
- 阵营与职业的关系说明

### 任务4.7：步骤5 - 填写细节（新建集中步骤）
**文件**：`components/steps/StepDetails.tsx`（新建）

**子步骤结构**：
```
5.1 职业特性
    ├─ 显示1级所有特性
    ├─ 选择职业技能 ← 从步骤1移到这里
    └─ 做出特性选择（战斗风格等）

5.2 专长确认
    ├─ 显示背景专长
    ├─ 人类额外专长选择（如果是人类）
    └─ 显示专长效果

5.3 技能汇总
    ├─ 职业技能
    ├─ 背景技能
    ├─ 物种技能
    └─ 专长技能

5.4 计算数值（自动）
    ├─ 生命值、AC、先攻
    ├─ 豁免、技能加值
    └─ 攻击、法术

5.5 装备确认
    ├─ 背景装备（已选）
    ├─ 职业起始装备
    └─ 购买额外装备（可选）

5.6 法术准备（施法者）
    ├─ 选择戏法
    ├─ 准备法术
    └─ 记录法术位

5.7 最终细节
    ├─ 外貌
    ├─ 个性
    └─ 背景故事
```

**分别创建子组件**：
- `components/steps/details/ClassFeatures.tsx`
- `components/steps/details/Feats.tsx`
- `components/steps/details/SkillsSummary.tsx`
- `components/steps/details/Calculations.tsx`
- `components/steps/details/Equipment.tsx`
- `components/steps/details/Spells.tsx`
- `components/steps/details/PersonalDetails.tsx`

### 任务4.8：步骤6 - 审核和完成（改进）
**文件**：`components/steps/StepReview.tsx`（重构）

**改进显示**：
- 分段显示所有信息
- 所有计算公式可见
- 可以返回任何步骤编辑
- 完整性检查
- 保存和导出按钮

### 任务4.9：更新主流程页面
**文件**：`app/create/page.tsx`（重构）

**改动**：
- 更新STEPS数组
- 实现子步骤导航
- 改进进度指示器
- 添加"跳过"和"返回"逻辑

---

## 🔗 阶段5：集成和优化（2-3天）

### 任务5.1：数据流整合
- 确保所有新字段正确保存到store
- 验证数据在各步骤间传递
- 测试localStorage持久化

### 任务5.2：PDF生成更新
**文件**：`lib/pdf-generator.ts`

**添加内容**：
- 专长列表
- 语言列表
- 背景故事（可选）
- 装备详细列表
- 改进的计算公式显示

### 任务5.3：UI/UX优化
- 改进进度指示器（显示子步骤）
- 添加帮助提示
- 优化移动端布局
- 添加动画过渡

### 任务5.4：全面测试
**创建测试用例**：
1. 战士（人类，士兵）- 测试人类专长选择
2. 法师（精灵，学者）- 测试精灵血统和施法
3. 牧师（矮人，侍僧）- 测试职业特性选择
4. 游侠（半身人，向导）- 测试完整流程

**测试检查点**：
- [ ] 所有步骤可正常导航
- [ ] 所有数据正确保存
- [ ] 属性计算正确
- [ ] 技能来源正确显示
- [ ] 专长正确获得
- [ ] 语言正确选择
- [ ] 装备正确选择
- [ ] PDF正确生成
- [ ] 可以编辑已保存角色

### 任务5.5：文档更新
- 更新README.md
- 更新使用指南
- 创建新的功能清单
- 更新CHANGELOG

---

## 📊 里程碑和时间线

### 第1周
- ✅ 阶段1完成（数据准备）
- ✅ 阶段2完成（数据结构）
- ⚠️ 阶段3进行50%（新组件）

### 第2周
- ✅ 阶段3完成（新组件）
- ✅ 阶段4完成（步骤重构）
- ⚠️ 阶段5进行50%（集成）

### 第3周
- ✅ 阶段5完成（集成和测试）
- ✅ 文档更新
- ✅ 发布新版本

---

## 🎯 成功标准

### 功能完整性
- [ ] 严格按照官方5步流程
- [ ] 75个起源专长完整
- [ ] 16个背景完整（含专长、装备、故事）
- [ ] 10个物种完整（含故事、寿命）
- [ ] 语言系统完整
- [ ] 技能系统完整（含来源追踪）

### 用户体验
- [ ] 流程清晰易懂
- [ ] 每步都有充分说明
- [ ] 可以随时返回修改
- [ ] 移动端体验良好
- [ ] 加载性能良好

### 数据准确性
- [ ] 所有规则符合2024版
- [ ] 所有计算正确
- [ ] 所有文本准确翻译
- [ ] PDF格式规范

---

## 🚦 当前状态

**阶段1：准备数据** - ⚪ 待开始
**阶段2：重构数据结构** - ⚪ 待开始  
**阶段3：创建新组件** - ⚪ 待开始
**阶段4：重构步骤流程** - ⚪ 待开始
**阶段5：集成和测试** - ⚪ 待开始

---

## 📝 注意事项

1. **向后兼容**：考虑已保存的角色数据迁移
2. **性能**：大量数据需要优化加载
3. **i18n**：所有文本已是中文，保持一致性
4. **测试**：每个阶段完成后立即测试
5. **备份**：重构前做好代码备份

---

**准备开始实施！** 🚀
