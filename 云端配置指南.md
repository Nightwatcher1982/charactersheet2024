# 云端认证与数据持久化配置指南

本项目已集成阿里云短信验证码登录和Postgres数据库持久化功能。按照以下步骤完成配置：

## 1. 数据库配置

### 安装PostgreSQL

**macOS (使用Homebrew):**
```bash
brew install postgresql@15
brew services start postgresql@15
```

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
```

### 创建数据库

```bash
# 进入PostgreSQL命令行
psql postgres

# 创建数据库和用户
CREATE DATABASE dnd_character_db;
CREATE USER dnd_user WITH ENCRYPTED PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE dnd_character_db TO dnd_user;
\q
```

### 配置环境变量

复制 `.env.example` 为 `.env` 并填写配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件：

```env
DATABASE_URL="postgresql://dnd_user:your_password@localhost:5432/dnd_character_db?schema=public"
SESSION_SECRET="your_session_secret_at_least_32_characters_long"

# 阿里云短信配置（可选，开发环境可不配置）
ALIYUN_ACCESS_KEY_ID="your_access_key_id"
ALIYUN_ACCESS_KEY_SECRET="your_access_key_secret"
ALIYUN_SMS_SIGN_NAME="你的短信签名"
ALIYUN_SMS_TEMPLATE_CODE="SMS_xxxxxxxxx"
```

### 运行数据库迁移

```bash
# 生成Prisma Client
npx prisma generate

# 创建数据库表
npx prisma migrate dev --name init

# 查看数据库（可选）
npx prisma studio
```

## 2. 阿里云短信服务配置（可选）

如果不配置阿里云短信服务，开发环境下验证码会在控制台输出。

### 获取阿里云AccessKey

1. 登录[阿里云控制台](https://ram.console.aliyun.com/manage/ak)
2. 创建AccessKey（AccessKeyId 和 AccessKeySecret）
3. 开通[短信服务](https://dysms.console.aliyun.com/)
4. 创建短信签名和短信模板

### 短信模板示例

模板内容：
```
您的验证码是${code}，5分钟内有效。请勿泄露给他人。
```

变量：`code`

### 配置环境变量

在 `.env` 中添加：

```env
ALIYUN_ACCESS_KEY_ID="your_access_key_id"
ALIYUN_ACCESS_KEY_SECRET="your_access_key_secret"
ALIYUN_SMS_SIGN_NAME="DND角色卡"
ALIYUN_SMS_TEMPLATE_CODE="SMS_123456789"
```

## 2.5 邮件推送（Direct Mail）配置（注册/改密/换邮箱验证码）

**重要：密钥和发信地址只写在你自己本机和服务器上的 `.env` 里，不要发给任何人、不要提交到 Git。**

### 需要配置的环境变量

在项目根目录的 `.env`（或 `.env.local`）中配置：

| 变量名 | 必填 | 说明 |
|--------|------|------|
| `ALIYUN_ACCESS_KEY_ID` | 是 | 阿里云 AccessKeyId（与短信可共用） |
| `ALIYUN_ACCESS_KEY_SECRET` | 是 | 阿里云 AccessKeySecret（与短信可共用） |
| `ALIYUN_DM_ACCOUNT_NAME` | 是 | 发信地址，在邮件推送控制台配置的「发信地址」，形如 `noreply@你的域名.com` |
| `ALIYUN_DM_FROM_ALIAS` | 否 | 发件人显示名称，如 `D&D角色卡`，不填则用默认 |

示例（请替换成你自己的值）：

```env
ALIYUN_ACCESS_KEY_ID="LTAI5txxxxxxxxxx"
ALIYUN_ACCESS_KEY_SECRET="xxxxxxxxxxxxxxxxxxxxxxxx"
ALIYUN_DM_ACCOUNT_NAME="noreply@yourdomain.com"
ALIYUN_DM_FROM_ALIAS="D&D角色卡"
```

### 在阿里云获取/配置这些信息

1. **AccessKey**（若已有短信配置可复用）
   - 登录 [RAM 访问控制](https://ram.console.aliyun.com/manage/ak) → 创建或查看 AccessKey，得到 `AccessKeyId` 和 `AccessKeySecret`。

2. **开通邮件推送（Direct Mail）**
   - 登录 [邮件推送控制台](https://dm.console.aliyun.com/)。
   - 个人账号需先完成实名认证，然后开通「邮件推送」（按量或资源包均可）。

3. **发信域名与发信地址**
   - 在邮件推送控制台添加并验证「发信域名」（需在域名服务商处添加给出的 MX/TXT 等解析）。
   - 在「发信地址」中创建发信地址（如 `noreply@你的域名.com`），该地址即 `ALIYUN_DM_ACCOUNT_NAME`。

4. **安全建议**
   - AccessKey 不要提交到代码仓库；生产环境使用独立子账号的 AccessKey，并限制仅访问邮件推送与所需资源。

### 不配置时行为

- **未配置** `ALIYUN_ACCESS_KEY_ID` / `ALIYUN_ACCESS_KEY_SECRET` 或 **未配置** `ALIYUN_DM_ACCOUNT_NAME`：
  - **开发环境**：不真实发邮件，验证码会打在**运行 Next 的终端**日志里，例如：`[DEV] 邮件验证码 -> user@example.com (register): 123456`，可直接用该验证码完成注册/改密等。
  - **生产环境**：接口会返回“验证码发送失败”，需按上面步骤配置后再发邮件。

### 本地环境测试真实邮件验证码

若希望在本地（`npm run dev`）也走真实发信、收到邮箱里的验证码，需**同时**满足：

1. **在 `.env` 中配置**（与生产相同）：
   - `ALIYUN_ACCESS_KEY_ID`
   - `ALIYUN_ACCESS_KEY_SECRET`
   - `ALIYUN_DM_ACCOUNT_NAME`（发信地址，如 `noreply@你的域名.com`）
   - `ALIYUN_DM_FROM_ALIAS`（可选，发件人显示名）

2. **阿里云侧已就绪**：
   - 已开通 [邮件推送（Direct Mail）](https://dm.console.aliyun.com/)（需实名认证）
   - 已添加并验证「发信域名」（在域名服务商处添加 MX/TXT 等解析）
   - 已在「发信地址」中创建发信地址，且该地址与 `ALIYUN_DM_ACCOUNT_NAME` 一致

3. **测试邮箱**：填写的收件邮箱建议先用你自己的常用邮箱；部分邮箱会拦截陌生发件人，可先看垃圾箱或把发信域名加入白名单。

4. **改完 `.env` 后**：重启 `npm run dev`，再在登录页点「注册」或「忘记密码」获取验证码，邮件会发到对应邮箱。

5. **强制走正式发信、不返回验证码**：若已配置上述变量，但本地仍希望与生产完全一致（不发控制台验证码、接口响应不包含 `code`），在 `.env` 中增加 `REAL_EMAIL_IN_DEV=1`。设置后本地行为与生产一致：只发真实邮件，验证码需到邮箱查看。

依赖已包含 `@alicloud/dm20151123`，无需额外安装。

### 配置完成后

- 本地：改完 `.env` 后重启 `npm run dev`。
- 服务器：在部署目录的 `.env` 里加上上述变量后，按你的方式重启应用（如 `systemctl restart charactersheet2024` 或重新执行部署脚本）。

无需把上述密钥或发信地址发给我或任何人，全部通过本机/服务器上的 `.env` 配置即可。

## 3. 启动应用

```bash
# 开发模式
npm run dev

# 生产模式
npm run build
npm start
```

## 4. 测试功能

1. 访问 `http://localhost:3000/login` 进入登录页面
2. 输入手机号（开发模式会在控制台显示验证码）
3. 输入验证码登录
4. 登录后可以同步本地角色到云端

## 5. API端点

### 认证相关
- `POST /api/auth/send-otp` - 发送验证码
- `POST /api/auth/verify-otp` - 验证验证码并登录
- `POST /api/auth/logout` - 退出登录
- `GET /api/auth/me` - 获取当前用户信息

### 角色管理
- `GET /api/characters` - 获取所有角色
- `POST /api/characters` - 创建角色
- `GET /api/characters/[id]` - 获取单个角色
- `PUT /api/characters/[id]` - 更新角色
- `DELETE /api/characters/[id]` - 删除角色
- `POST /api/characters/import` - 批量导入本地角色

## 6. 部署到阿里云

### 使用现有脚本部署

```bash
# 首次部署（需要先在服务器上安装Node.js和PostgreSQL）
bash scripts/bootstrap-aliyun.sh

# 后续更新
bash scripts/deploy-aliyun.sh
```

### 服务器环境要求

- Node.js 18+
- PostgreSQL 12+
- Nginx（可选，用于反向代理）

### Nginx配置示例

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

## 7. 安全注意事项

1. **生产环境务必更换SESSION_SECRET**
2. **保护好数据库连接字符串**
3. **不要将 .env 文件提交到版本控制**
4. **使用HTTPS传输敏感数据**
5. **定期备份数据库**

## 8. 开发模式特性

- 不配置阿里云短信时，验证码会在服务器控制台输出
- 验证码也会在API响应中返回（仅开发环境）
- 可以使用任意验证码登录（需要在数据库中存在对应记录）

## 9. 故障排查

### 数据库连接失败
- 检查PostgreSQL是否运行：`pg_isready`
- 检查DATABASE_URL配置是否正确
- 确认数据库用户权限

### 短信发送失败
- 检查阿里云AccessKey是否正确
- 确认短信服务余额充足
- 查看短信模板是否审核通过

### 会话问题
- 清除浏览器Cookie
- 检查SESSION_SECRET是否配置
- 确认服务器时间正确

## 10. 下一步

配置完成后，用户可以：

1. 使用手机号登录
2. 将本地角色同步到云端
3. 在多设备间同步角色数据
4. 安全地管理和备份角色信息

## 11. 子路径部署 Nginx 配置（必读：避免首页白屏/空文档）

**根目录约定**：本应用在服务器上的根地址为 **https://dimvision.xyz/charactersheet2024/**，与主站 https://dimvision.xyz/（其他应用）分离。用户访问、登录、首页及所有路由均在此前缀下，不会跳转到主站根路径。

站点部署在子路径（如 `https://dimvision.xyz/charactersheet2024/`）时，**必须**把完整路径转发给 Next.js，否则会出现「文档请求 200 但 0 kB、页面白屏」。

**错误示例**（会导致首页返回空 HTML）：

```nginx
location /charactersheet2024/ {
    proxy_pass http://127.0.0.1:3100/;   # 末尾的 / 会截掉路径，Node 只收到 /
    ...
}
```

**正确配置**：`proxy_pass` 的 URL **不要带路径**，让 Nginx 把完整请求 URI 原样转发：

```nginx
server {
    listen 80;
    server_name dimvision.xyz;

    location /charactersheet2024/ {
        proxy_pass http://127.0.0.1:3100;   # 不要写成 http://127.0.0.1:3100/
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

修改后执行 `nginx -t` 检查，`systemctl reload nginx` 重载。

### 11.1 图片与静态资源长期缓存（可选）

在以上 `location /charactersheet2024/` 之前增加更精确的 location，对图片和 Next 静态资源加缓存头：

```nginx
# 静态资源长期缓存（图片、_next/static）
location ~ ^/charactersheet2024/(pic/|_next/static/) {
    proxy_pass http://127.0.0.1:3100;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header Cache-Control "public, max-age=31536000, immutable";
}
```

然后执行 `nginx -t` 检查配置，`systemctl reload nginx` 重载。

## 12. 背景步骤图片加载优化

「确定起源」步骤中背景卡片图片（`public/pic/background/`）单张约 500–600KB，若感觉加载较慢可做以下其一：

- **压缩原图**：用 [Squoosh](https://squoosh.app)、ImageOptim 等将 JPG 质量降到 75–80，或导出为 WebP，替换原文件。
- **使用缩略图**：在本地用工具生成约 160×160 的小图（如 `侍僧-thumb.jpg`），替换 `public/pic/background/` 中对应文件；或保留原图备份，仅把缩略图放到该目录并改组件中的引用为缩略图路径。

代码中已对背景卡片使用 `loading="lazy"`，仅进入视口时加载，可减轻首屏压力。

## 13. 图片走 OSS + CDN（文件桶加速）

把 `public/pic/` 放到对象存储（如阿里云 OSS）并开启 CDN，可明显加快图片加载（尤其对离服务器较远的用户）。

### 13.0 若出现 403 Forbidden：将 Bucket 设为公共读

浏览器直接访问 OSS 图片若返回 **403 Forbidden**，说明 Bucket 未允许匿名读。请按以下步骤开放：

1. 登录 [阿里云 OSS 控制台](https://oss.console.aliyun.com/)。
2. 点击 Bucket 名称（如 **dndcharacter2024**）进入该 Bucket。
3. 左侧菜单进入 **权限管理** → **读写权限**。
4. 将 **读写权限** 改为 **公共读**（仅允许匿名读对象，写仍需鉴权），保存。

保存后，再刷新页面，图片应能正常加载。

**用户立绘上传与权限说明：**

- **公共读**：Bucket 设为「公共读」后，任何人可通过对象 URL 访问图片，用于页面展示。**仅公共读即可，不需要、也不应设为「公共写」**（公共写会让任何人往你 Bucket 里乱传文件）。
- **写由后端完成**：用户选择图片后，浏览器把文件发给**我们的后端**；后端用 `.env` 中的 `ALIYUN_ACCESS_KEY_ID` / `ALIYUN_ACCESS_KEY_SECRET` 调用 OSS SDK 上传到 Bucket。因此**写操作由服务器上的 AccessKey 完成**，不暴露给前端。
- **额外配置**：确保该 AccessKey 在阿里云 RAM 中对该 Bucket 有 **PutObject**（及可选 ListObjects、DeleteObject）权限。主账号的 AccessKey 默认有完整 OSS 权限；若使用子账号，需在 RAM 中为该账号授权对应 Bucket 的写权限。
- **环境变量**：立绘上传接口需要 `OSS_BUCKET`、`OSS_REGION`（或 `ALIYUN_OSS_BUCKET` / `ALIYUN_OSS_REGION`），以及 `ALIYUN_ACCESS_KEY_ID`、`ALIYUN_ACCESS_KEY_SECRET`（可与邮件推送共用）。`NEXT_PUBLIC_PIC_BASE_URL` 需带 `https://` 和路径前缀（如 `https://你的Bucket.oss-cn-shanghai.aliyuncs.com/charactersheet2024`），上传后返回的 URL 才能正确访问。

### 13.1 创建 OSS 存储桶并开启 CDN

1. 登录 [阿里云 OSS 控制台](https://oss.console.aliyun.com/)，创建 Bucket（如 `dimvision-static`），地域选与业务相近的，读写权限选「公共读」。
2. 在 Bucket 内建目录：`charactersheet2024/pic/`（与站点 basePath 一致，便于同一 CDN 域名下区分）。
3. 可选：在 [CDN 控制台](https://cdn.console.aliyun.com/) 为该 Bucket 添加加速域名（如 `cdn.dimvision.xyz`），源站选择该 OSS Bucket。绑定并解析后，图片请求会走 CDN 边缘节点。

### 13.2 上传图片到 OSS

本地安装 [ossutil](https://help.aliyun.com/document_detail/120075.html) 并完成 `ossutil config` 后，在项目根目录执行：

```bash
# 方式一：使用项目自带脚本（推荐）
OSS_BUCKET=你的Bucket名 ./scripts/sync-pic-to-oss.sh

# 方式二：直接调用 ossutil
ossutil cp -r public/pic/ oss://你的Bucket名/charactersheet2024/pic/ --update
```

以后有新增或修改图片时（如登录页 `login-bg.png`、创建页背景、**账号设置页** `settings-bg.png` 等），再执行一次上述同步即可。

### 13.3 配置应用使用 CDN 地址

- **方式 A：用 OSS 外网 Endpoint**  
  在服务器 `.env` 或构建环境变量中设置（本项目示例）：
  ```env
  NEXT_PUBLIC_PIC_BASE_URL=https://dndcharacter2024.oss-cn-shanghai.aliyuncs.com/charactersheet2024
  ```
  注意不要末尾斜杠；应用内所有以 `/pic/` 开头的路径都会拼成该前缀（如 `/pic/home-bg.png` → `https://dndcharacter2024.oss-cn-shanghai.aliyuncs.com/charactersheet2024/pic/home-bg.png`）。

- **方式 B：用 CDN 加速域名**  
  若已绑定 CDN 域名（如 `cdn.dimvision.xyz`），则设置为：
  ```env
  NEXT_PUBLIC_PIC_BASE_URL=https://cdn.dimvision.xyz/charactersheet2024
  ```

设置后需**重新构建并重启**（`NEXT_PUBLIC_*` 在构建时注入）。

**在服务器上一次性添加变量并重建（按当前部署方式）：**

在**本机**执行（会 SSH 到服务器执行）：

```bash
# 1）在服务器 .env 中追加 OSS 图片地址（若已存在可跳过）
ssh root@47.238.5.63 "grep -q 'NEXT_PUBLIC_PIC_BASE_URL' /opt/charactersheet2024/current/.env || echo 'NEXT_PUBLIC_PIC_BASE_URL=https://dndcharacter2024.oss-cn-shanghai.aliyuncs.com/charactersheet2024' >> /opt/charactersheet2024/current/.env"

# 2）在服务器上重新构建并重启（构建会读取 .env 中的 NEXT_PUBLIC_*）
ssh root@47.238.5.63 "cd /opt/charactersheet2024/current && npm run build && systemctl restart charactersheet2024"
```

或登录服务器后执行：

```bash
# 登录
ssh root@47.238.5.63

# 若 .env 中还没有 NEXT_PUBLIC_PIC_BASE_URL，追加一行
grep -q 'NEXT_PUBLIC_PIC_BASE_URL' /opt/charactersheet2024/current/.env || echo 'NEXT_PUBLIC_PIC_BASE_URL=https://dndcharacter2024.oss-cn-shanghai.aliyuncs.com/charactersheet2024' >> /opt/charactersheet2024/current/.env

# 重新构建并重启
cd /opt/charactersheet2024/current && npm run build && systemctl restart charactersheet2024
```
