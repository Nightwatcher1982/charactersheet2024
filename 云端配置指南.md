# 云端认证与数据持久化配置指南

本项目已集成阿里云短信验证码登录和Postgres数据库持久化功能。按照以下步骤完成配置：

## 1. 数据库配置

### 安装PostgreSQL

**macOS (使用Homebrew):**
```bash
brew install postgresql@15
brew services start postgresql@15
```

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
```

### 创建数据库

```bash
# 进入PostgreSQL命令行
psql postgres

# 创建数据库和用户
CREATE DATABASE dnd_character_db;
CREATE USER dnd_user WITH ENCRYPTED PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE dnd_character_db TO dnd_user;
\q
```

### 配置环境变量

复制 `.env.example` 为 `.env` 并填写配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件：

```env
DATABASE_URL="postgresql://dnd_user:your_password@localhost:5432/dnd_character_db?schema=public"
SESSION_SECRET="your_session_secret_at_least_32_characters_long"

# 阿里云短信配置（可选，开发环境可不配置）
ALIYUN_ACCESS_KEY_ID="your_access_key_id"
ALIYUN_ACCESS_KEY_SECRET="your_access_key_secret"
ALIYUN_SMS_SIGN_NAME="你的短信签名"
ALIYUN_SMS_TEMPLATE_CODE="SMS_xxxxxxxxx"
```

### 运行数据库迁移

```bash
# 生成Prisma Client
npx prisma generate

# 创建数据库表
npx prisma migrate dev --name init

# 查看数据库（可选）
npx prisma studio
```

## 2. 阿里云短信服务配置（可选）

如果不配置阿里云短信服务，开发环境下验证码会在控制台输出。

### 获取阿里云AccessKey

1. 登录[阿里云控制台](https://ram.console.aliyun.com/manage/ak)
2. 创建AccessKey（AccessKeyId 和 AccessKeySecret）
3. 开通[短信服务](https://dysms.console.aliyun.com/)
4. 创建短信签名和短信模板

### 短信模板示例

模板内容：
```
您的验证码是${code}，5分钟内有效。请勿泄露给他人。
```

变量：`code`

### 配置环境变量

在 `.env` 中添加：

```env
ALIYUN_ACCESS_KEY_ID="your_access_key_id"
ALIYUN_ACCESS_KEY_SECRET="your_access_key_secret"
ALIYUN_SMS_SIGN_NAME="DND角色卡"
ALIYUN_SMS_TEMPLATE_CODE="SMS_123456789"
```

## 3. 启动应用

```bash
# 开发模式
npm run dev

# 生产模式
npm run build
npm start
```

## 4. 测试功能

1. 访问 `http://localhost:3000/login` 进入登录页面
2. 输入手机号（开发模式会在控制台显示验证码）
3. 输入验证码登录
4. 登录后可以同步本地角色到云端

## 5. API端点

### 认证相关
- `POST /api/auth/send-otp` - 发送验证码
- `POST /api/auth/verify-otp` - 验证验证码并登录
- `POST /api/auth/logout` - 退出登录
- `GET /api/auth/me` - 获取当前用户信息

### 角色管理
- `GET /api/characters` - 获取所有角色
- `POST /api/characters` - 创建角色
- `GET /api/characters/[id]` - 获取单个角色
- `PUT /api/characters/[id]` - 更新角色
- `DELETE /api/characters/[id]` - 删除角色
- `POST /api/characters/import` - 批量导入本地角色

## 6. 部署到阿里云

### 使用现有脚本部署

```bash
# 首次部署（需要先在服务器上安装Node.js和PostgreSQL）
bash scripts/bootstrap-aliyun.sh

# 后续更新
bash scripts/deploy-aliyun.sh
```

### 服务器环境要求

- Node.js 18+
- PostgreSQL 12+
- Nginx（可选，用于反向代理）

### Nginx配置示例

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

## 7. 安全注意事项

1. **生产环境务必更换SESSION_SECRET**
2. **保护好数据库连接字符串**
3. **不要将 .env 文件提交到版本控制**
4. **使用HTTPS传输敏感数据**
5. **定期备份数据库**

## 8. 开发模式特性

- 不配置阿里云短信时，验证码会在服务器控制台输出
- 验证码也会在API响应中返回（仅开发环境）
- 可以使用任意验证码登录（需要在数据库中存在对应记录）

## 9. 故障排查

### 数据库连接失败
- 检查PostgreSQL是否运行：`pg_isready`
- 检查DATABASE_URL配置是否正确
- 确认数据库用户权限

### 短信发送失败
- 检查阿里云AccessKey是否正确
- 确认短信服务余额充足
- 查看短信模板是否审核通过

### 会话问题
- 清除浏览器Cookie
- 检查SESSION_SECRET是否配置
- 确认服务器时间正确

## 10. 下一步

配置完成后，用户可以：

1. 使用手机号登录
2. 将本地角色同步到云端
3. 在多设备间同步角色数据
4. 安全地管理和备份角色信息

## 11. 图片加载优化（Nginx 缓存）

若站点部署在子路径（如 `/charactersheet2024`），可在 Nginx 中为静态资源增加长期缓存，减少重复访问时的加载时间。

在 `location ^~ /charactersheet2024/` 之前增加更精确的 location，对图片和 Next 静态资源加缓存头：

```nginx
# 静态资源长期缓存（图片、_next/static）
location ~ ^/charactersheet2024/(pic/|_next/static/) {
    proxy_pass http://127.0.0.1:3100;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header Cache-Control "public, max-age=31536000, immutable";
}
```

然后执行 `nginx -t` 检查配置，`systemctl reload nginx` 重载。
